<!doctype html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R6EB30MS2M"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-R6EB30MS2M');
</script>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TVXN8RM9');</script>
<!-- End Google Tag Manager -->
<meta charset="utf-8">
<title>Sublime Sounds ‚Äì Rhythm Master - Beta Testing Phase</title>
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
/>
<script src="https://notify.waxsweden.org/static/assets/waxjs.js"></script>
<script src="https://unpkg.com/anchor-link@3"></script>
<script src="https://unpkg.com/anchor-link-browser-transport@3"></script>

<style>

@keyframes upgradePulse {
  0%   { transform: scale(1); box-shadow: 0 0 0 rgba(34,211,238,0); }
  50%  { transform: scale(1.08); box-shadow: 0 0 32px rgba(34,211,238,1); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(34,211,238,0); }
}

.nft-card.upgraded {
  animation: upgradePulse 0.8s ease-out;
}

#upgradeOverlay {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle at center, rgba(0,0,0,.65), rgba(0,0,0,.95));
  z-index: 999999;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: all;
}

.upgrade-core {
  position: relative;
  width: 220px;
  height: 220px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.upgrade-ring {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  border: 6px solid transparent;
  border-top-color: #22c55e;
  border-right-color: #ec4899;
  animation: spinUpgrade 1.1s linear infinite;
  box-shadow: 0 0 28px rgba(34,197,94,.8);
}

.upgrade-text {
  font-size: 18px;
  font-weight: 900;
  letter-spacing: 2px;
  text-align: center;
  color: #22c55e;
  animation: pulseText 1.4s ease-in-out infinite;
}

@keyframes spinUpgrade {
  to { transform: rotate(360deg); }
}

@keyframes pulseText {
  0%,100% { opacity: .7; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.08); }
}

/* SUCCESS FLASH */
.upgrade-success {
  animation: upgradeSuccess .7s ease-out forwards;
}

@keyframes upgradeSuccess {
  0% { transform: scale(.9); opacity: 0; }
  30% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(1); opacity: 0; }
}

.spark,
.judge,
.combo-celebrate {
  pointer-events: none;
}

#game,
#game * {
  user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}

#rescanBtn {
  background: #22d3ee;
  color: #000;
}

#rescanBtn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
#gameOver {
  z-index: 999999;
}
.note {
  opacity: 0;          /* hidden by default */
}
.note.visible {
  opacity: 1;
}
#game:fullscreen,
#game:-webkit-full-screen {
  height: 100vh !important;
}

#walletBadge {
  display: flex;
  align-items: center;
  justify-content: center;

  min-width: 56px;
  height: 24px;

  padding: 0 10px;
  margin-left: 6px;

  font-size: 12px;
  font-weight: 800;

  line-height: 24px;        /* üî• THIS is the key */
  text-align: center;

  text-transform: uppercase;
  letter-spacing: 0.5px;

  border-radius: 999px;
  white-space: nowrap;

  box-sizing: border-box;   /* üîí prevents padding drift */
}
/* üîï Disable blinking text cursor (caret) globally */
* {
  caret-color: transparent;
}
#comboOverlay {
  position: fixed;
  inset: 0;
  z-index: 2147483647; /* max safe z-index */
  pointer-events: none;
}
/* ===== COMBO CELEBRATIONS ===== */
.combo-celebrate {
  position: fixed; /* üîë was absolute */
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) scale(1);
  font-weight: 900;
  text-align: center;
  pointer-events: none;
  z-index: 99999; /* üî• above EVERYTHING */
  animation: comboPop 2s forwards, comboGlow 0.6s ease-out;
}

@keyframes comboGlow {
  0% { filter: brightness(1); }
  50% { filter: brightness(1.3); }
  100% { filter: brightness(1); }
}

.combo-5 {
  font-size: 36px;
  color: #22c55e; /* green */
  text-shadow: 0 0 12px rgba(34,197,94,0.9);
}

.combo-10 {
  font-size: 42px;
  color: #22d3ee;
  text-shadow: 0 0 14px rgba(34,211,238,0.9);
}

.combo-20 {
  font-size: 54px;
  color: #FF0000;
  text-shadow: 0 0 22px rgba(56,189,248,1);
}

.combo-30 {
  font-size: 68px;
  color: #ff5fd2;
  text-shadow:
    0 0 18px #ff5fd2,
    0 0 36px #ff5fd2;
}

.combo-50 {
  font-size: 84px;
  color: #facc15; /* gold */
  letter-spacing: 2px;
  text-shadow:
    0 0 18px #facc15,
    0 0 36px #facc15,
    0 0 64px rgba(250,204,21,0.9);
}

.combo-nft {
  font-size: 72px;
  color: #22c55e;
  letter-spacing: 10px;

  text-shadow:
    0 0 18px rgba(34,197,94,1),
    0 0 36px rgba(34,197,94,0.9),
    0 0 64px rgba(34,197,94,0.8);
}

@keyframes comboPop {
  0%   { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
  15%  { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
  80%  { opacity: 1; }
  100% { opacity: 0; transform: translate(-50%, -50%) scale(1.25); }
}
body::before {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(5, 5, 16, 0.9); /* adjust opacity if needed */
  pointer-events: none;
  z-index: -1;
}

html, body {
  margin: 0;
  padding: 0;
  color: #fff;
  font-family: system-ui;

  background-color: #050510;

  background-repeat: no-repeat, no-repeat;

  background-position:
    top 20px left 20px,
    top 20px right 20px;

  background-size:
    260px auto,
    260px auto;
}
main{max-width:1300px;margin:auto;padding:14px}
h1{text-align:center}

* {
  -webkit-overflow-scrolling: touch;
}

#game,
#lanes,
.note,
.spark {
  will-change: transform;
}

#game {
  touch-action: manipulation;
}

html {
  height: 100%;
  overflow-y: auto;
}

body {
  height: auto;
}

#page {
  min-height: 100vh;
}


/* ===== AD SLOTS (CLEAN) ===== */
.ad-slot {
  height: 180px;
  border-radius: 12px;
  background: #020617;
  border: 1px dashed rgba(255,255,255,0.15);

  /* üî¥ REMOVE FLEX CENTERING */
  display: block;

  overflow: hidden;
  color: rgba(255,255,255,0.35);
  font-weight: 800;
  font-size: 14px;
}

.ad-slot.ad-image {
  padding: 0;
}

.ad-slot.ad-image a {
  display: block;
  width: 100%;
  height: 100%;
}

.ad-slot.ad-image img {
  display: block;
  width: 100%;
  height: 100%;
  object-fit: cover;   /* FULL BLEED */
}

/* üîí Lock gestures ONLY inside the game */
body.playing #game {
  touch-action: none;
}
/* Prevent scroll ONLY when interacting with the game */
#game {
  touch-action: manipulation;
}
#gameOver{
  z-index: 10;
  pointer-events: auto;
}

#gameOver button{
  pointer-events: auto;
}
#headerRow{
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 16px;
  margin: 8px 0 10px;
}

#bottomRow{
  display: grid;
  grid-template-columns: repeat(3, 1fr) 320px;
  grid-template-rows: repeat(2, 180px);
  gap: 14px;
  margin-top: 14px;
}

#lbLogoWrap{
  grid-column: 4;
  grid-row: 1 / span 2;
  display: flex;
  align-items: center;
  justify-content: center;

  background-color: #020617;
  border-radius: 14px;

  /* üî• LOGO AS BACKGROUND */
  background-image: url("img/rhythm-master-tr.png");
  background-repeat: no-repeat;
  background-position: center;
  background-size: contain;

  /* optional visual polish */
  filter: drop-shadow(0 0 18px rgba(236,72,153,0.45));
}

/* Logo */
#gameLogo{
  max-width: 260px;
  width: 100%;
  height: auto;
}
#titleRow{
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 16px;
  margin: 6px 0 10px;
}

/* Logo */
#titleLogo{
  max-width: 240px;   /* keeps it compact */
  width: 100%;
  height: auto;
}

/* UI */
button,select{
  padding:10px 14px;border-radius:8px;border:none;
  background:#ec4899;color:#fff;font-weight:700;cursor:pointer
}
button.secondary{background:#22d3ee;color:#000}
button.warn{background:#dc2626}
button:disabled{opacity:.4}

#top,#payment,#hud{
  display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:10px
}

#multiplier{
  padding:6px 16px;border-radius:999px;background:#111827
}

/* ===== MULTIPLIER VISUAL STATES ===== */
#multiplier.x1 {
  background: #111827;
  color: #fff;
}

#multiplier.x2 {
  background: #facc15;
  color: #000;
  animation: pulseYellow 0.9s infinite;
  box-shadow: 0 0 18px rgba(250,204,21,0.9);
}

#multiplier.x3 {
  background: #dc2626;
  color: #fff;
  animation: pulseRed 0.9s infinite;
  box-shadow: 0 0 24px rgba(220,38,38,0.95);
}

@keyframes pulseYellow {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.08); }
  100% { transform: scale(1); }
}

@keyframes pulseRed {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.12); }
  100% { transform: scale(1); }
}

#layout{
  display:grid;
  grid-template-columns:1fr 320px;
  gap:14px;
  margin-top:14px;
}

/* GAME */
#game{
  position:relative;height:420px;border-radius:14px;
  background:#020617;overflow:hidden;outline:none
}
#game.shake{animation:shake .18s}
@keyframes shake{
  25%{transform:translate(-6px,4px)}
  50%{transform:translate(6px,-4px)}
  75%{transform:translate(-4px,-6px)}
}

#bg, #bgVideo{
  position:absolute;inset:0;
  width:100%;height:100%;
  object-fit:cover;
  opacity:.35;
  z-index:0;
}

#bg{background-size:cover;background-position:center}
#bgVideo{display:none}

#lanes{position:absolute;inset:0;display:flex;z-index:1}

.lane{
  width:20%;position:relative;cursor:pointer;
  border-left:1px solid rgba(255,255,255,.1);
  border-right:1px solid rgba(255,255,255,.1);
}
.lane.hit{background:rgba(34,211,238,.18)}
.lane.perfect{
  background:rgba(236,72,153,.35);
  box-shadow:inset 0 0 40px rgba(236,72,153,1)
}

.key{
  position:absolute;bottom:10px;left:50%;
  transform:translateX(-50%);
  font-size:26px;font-weight:900;opacity:.8
}

.note{
  position:absolute;
  top:-20px;
  left:10%;
  width:80%;
  height:16px;
  border-radius:8px;
  background:#ec4899;
}

.note.mult-x2,
.note.mult-x3{
  overflow: visible;          /* ‚úÖ allow text outside bar */
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
}

.note.mult-x2{
  background:#facc15;
  color:#fff;                 /* ‚úÖ X2 text now WHITE */
}

.note.mult-x3{
  background:#dc2626;
  color:#fff;
}

/* ===== NFT NOTE ===== */
.note.mult-nft {
  background: linear-gradient(90deg, #16a34a, #22c55e, #16a34a);
  color: #ffffff;

  box-shadow:
    0 0 12px rgba(34,197,94,0.9),
    0 0 28px rgba(34,197,94,0.8);

  animation: nftPulse 1.1s infinite ease-in-out;
  overflow: visible;
}

/* Big centered NFT text */
.note.mult-nft::after {
  content: "N F T";
  position: absolute;
  inset: 0;

  display: flex;
  align-items: center;
  justify-content: center;

  font-size: 26px;
  font-weight: 900;
  letter-spacing: 6px;

  color: #ffffff;
  text-shadow:
    0 0 6px rgba(0,0,0,0.5),
    0 0 14px rgba(34,197,94,1);

  pointer-events: none;
}

/* Pulsating glow animation */
@keyframes nftPulse {
  0% {
    transform: scale(1);
    filter: brightness(1);
  }
  50% {
    transform: scale(1.08);
    filter: brightness(1.35);
  }
  100% {
    transform: scale(1);
    filter: brightness(1);
  }
}

.note.ssn {
  background: #ec4899;
  box-shadow: 0 0 18px rgba(236,72,153,0.9);
  animation: ssnPulse 1.1s infinite;
}

@keyframes ssnPulse {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.12); }
  100% { transform: scale(1); }
}

.note.ssn::after {
  content: attr(data-label);
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 20px;
  color: #fff;
  text-shadow: 0 0 10px rgba(255,255,255,0.8);
}

/* BIG TEXT */
.note.mult-x2::after,
.note.mult-x3::after{
  content: attr(data-label);
  position: absolute;
  inset: 0;                   /* ‚úÖ perfect centering */
  display: flex;
  align-items: center;
  justify-content: center;

  font-size: 28px;
  font-weight: 900;
  pointer-events: none;

  text-shadow:
    0 0 6px rgba(0,0,0,.45),
    0 0 14px rgba(0,0,0,.35);
}

#hitLine{
  position:absolute;left:0;right:0;bottom:80px;
  height:3px;background:#22d3ee;box-shadow:0 0 18px #22d3ee;
  z-index:1
}


/* JUDGEMENT */
.judge{
z-index: 5; 
  position:absolute;left:50%;bottom:120px;
  transform:translateX(-50%);
  font-size:36px;font-weight:900;
  animation:judge .6s forwards;
  pointer-events:none
}
.judge.sublime{
  color:#ff5fd2;
  text-shadow:0 0 12px #ff5fd2,0 0 32px #ff5fd2
}
.judge.great{color:#22d3ee}
.judge.ok{color:#facc15}
.judge.miss{color:#f87171}
@keyframes judge{
  to{opacity:0;transform:translateX(-50%) scale(1.3)}
}

/* SPARKS */
.spark{
  position:fixed;border-radius:50%;
  pointer-events:none;z-index:9999;
  animation:spark .35s ease-out forwards
}
@keyframes spark{
  from{opacity:1;transform:scale(.4)}
  to{opacity:0;transform:scale(1.4)}
}

/* MULTIPLIER FLASH */
#flash{
  position: absolute;
  inset: 0;
  pointer-events: none;
  opacity: 0;
  z-index: 9;
}

#flash.x2{
  background: rgba(250,204,21,0.6);
}

#flash.x3{
  background: rgba(220,38,38,0.6);
}

#flash.active{
  animation: flash .18s ease-out;
}

@keyframes flash{
  from{opacity:1}
  to{opacity:0}
}

/* GAME OVER */
#gameOver{
  position:absolute;inset:0;background:rgba(0,0,0,.75);
  display:none;align-items:center;justify-content:center
}
#gameOver .box{
  background:#020617;padding:22px 26px;border-radius:14px;text-align:center

}

#bottomRow .ad-slot {
  height: 100%;
}

/* LEADERBOARD */
#leaderboard{
  background:#020617;border-radius:14px;padding:12px
}
#leaderboard h3{text-align:center;margin:4px 0 10px}
.lb-row{
  display:flex;justify-content:space-between;
  padding:4px 0;font-size:14px;
  border-bottom:1px solid rgba(255,255,255,.08)
}
.lb-empty{text-align:center;opacity:.6;font-size:14px}

#lbLogo img{
  max-width: 100%;
  width: 260px;        /* keeps it tidy */
  height: auto;
  filter: drop-shadow(0 0 14px rgba(236,72,153,0.45));
}
@media (max-width: 900px) {

  #layout{
    grid-template-columns: 1fr; /* stack */
  }

  #leaderboard{
    margin-top: 14px;
  }

}
@media (max-width: 900px) {

  #bottomRow{
    grid-template-columns: 1fr;
    grid-template-rows: auto;
  }

  #lbLogoWrap{
    grid-column: auto;
    grid-row: auto;
    height: 220px;
  }

}
@media (max-width: 600px) {

  #game{
    height: 340px;
  }

  .key{
    font-size: 20px;
  }

  .judge{
    font-size: 28px;
  }

}
@media (max-width: 600px) {

  #titleLogo{
    max-width: 180px;
  }

  .ad-slot{
    height: 140px;
  }

}
/* ===== ROTATE DEVICE HINT (MOBILE ONLY) ===== */
#rotateHint {
  height: 100dvh;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 99999;

  display: none;
  align-items: center;
  justify-content: center;

  pointer-events: none; /* ‚úÖ CRITICAL */
}
/* ===== TABLET OPTIMISATION ===== */
@media (min-width: 768px) and (max-width: 1100px){

  #layout{
    grid-template-columns: 1fr 280px;
  }

  #game{
    height: 380px;
  }

  #titleLogo{
    max-width: 220px;
  }

}
</style>
</head>

<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TVXN8RM9"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<div id="page">
<main>
<div id="titleRow">
  <div class="ad-slot ad-image">
  <a href="https://galactic123.net" target="_blank">
    <img src="img/galactic123.png" alt="Galactic123">
  </a>
</div>

  <img
    src="img/rhythm-master-tr.png"
    alt="Rhythm Master"
    id="titleLogo"
  />

  <div class="ad-slot ad-image">
  <a href="https://metabattler.io" target="_blank">
    <img src="img/metabattler.png" alt="MetaBattler">
  </a>
</div>
</div>

<div id="top">
  <button id="loginBtn">Connect WAX</button>
  <button id="anchorLoginBtn" class="secondary">Anchor</button>
  <span id="userLabel"></span>
<span id="walletBadge" style="display:none; margin-left:6px;"></span>
  <select id="trackSelect" disabled></select>
<div id="nftList" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;"></div>
<span id="nftLevelBadge" style="display:none;"></span>
<button id="rescanBtn" disabled>Re-scan Wallet</button>
<button id="payBtn" class="secondary">Pay 100 SSN</button>
  <button id="startBtn" disabled>Start</button>
</div>

<div id="payment">
<select id="upgradePath" disabled>
  <option value="">Choose upgrade</option>
  <option value="score">+10% Score</option>
  <option value="ssn">+10% SSN</option>
  <option value="both">+10% Score & SSN</option>
</select>
<button id="upgradenft" disabled>Upgrade NFT</button>
  <span id="payStatus"></span>
  <a id="txLink" target="_blank" style="display:none">View Tx</a>
  <button id="seasonResetBtn" class="warn" style="display:none">New Season (Admin)</button>
</div>

<div id="hud">
  <div>
    Score: <span id="scoreEl">0</span>
    <span style="margin-left:12px; color:#ec4899; font-weight:700;">
      +SSN: <span id="ssnEl">0</span>
    </span>
  </div>
  <div>Combo: <span id="comboEl">0</span></div>
  <div id="multiplier">x1</div>
  <div id="restartCounter" style="opacity:.8; font-size:14px">
    Restarts left: 3 / 3
  </div>
</div>

<div id="layout">
  <div id="game" tabindex="0">
    <video id="bgVideo" playsinline muted preload="auto"></video>
    <div id="bg"></div>
    <div id="flash"></div>
    <div id="lanes"></div>
    <div id="hitLine"></div>

  <!-- ‚úÖ MOVE OVERLAY HERE -->
  <div id="comboOverlay"></div>

    <div id="gameOver">
      <div class="box">
        <h2>Game Over</h2>
        <div>Final Score: <b id="finalScore">0</b></div>
	<div id="ssnEarned">SSN Earned: 0</div>
    	<div id="nftWonBadge" style="display:none; margin-top:10px;">
  üéÅ NFT WON<br>
  <a id="nftTxLink" target="_blank" style="color:#22c55e; font-weight:700;"></a>
</div>
	<button onclick="closeGameOver()">OK</button>
        <button onclick="restartGame()" class="secondary">Restart</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ LEADERBOARD COLUMN -->
  <div id="leaderboard">
    <h3>Leaderboard</h3>
<button
  id="clearTrackBtn"
  class="warn"
  style="display:none"
>
  Clear This Track (Admin)
</button>
    <div id="lbList"></div>
  </div>
</div>

<!-- üëá THIS MUST BE OUTSIDE #layout -->
<div id="bottomRow">
  <div class="ad-slot ad-image">
  <a href="https://www.wax.io" target="_blank" rel="noopener noreferrer">
    <img
      src="img/waxlogo.png"
      alt="WAX Blockchain"
    >
  </a>
</div>
  <div class="ad-slot ad-image">
  <a href="https://neftyblocks.com/collection/sublimesound" target="_blank">
    <img src="img/seasonpass.png" alt="Buy Sublime Sounds NFTs">
  </a>
</div>
<div class="ad-slot ad-image">
  <a href="https://neftyblocks.com/collection/sublimesound" target="_blank">
    <img src="img/nfts.png" alt="Buy Sublime Sounds NFTs">
  </a>
</div>

  <div class="ad-slot ad-image">
  <a href="https://muenstervision.co/" target="_blank">
    <img src="img/Muenstervision.png" alt="Muenstervision">
  </a>
</div>
   <div class="ad-slot ad-image">
  <a href="https://waxcleanup.github.io/" target="_blank">
    <img src="img/cleanupcentr.png" alt="CleanUpCentr">CleanUp Centr
  </a>
</div>
     <div class="ad-slot ad-image">
  <a href="https://waxdao.io/" target="_blank">
    <img src="img/waxdao.png" alt="WaxDAO">CleanUp Centr
  </a>
</div>

<div id="lbLogoWrap"></div>
</div>
</main>
<div id="rotateHint">
  <div class="rotate-box">
    <div class="icon">üì±‚Üª</div>
    <div class="text">
      Rotate your device<br>
      for the best experience
    </div>
  </div>
</div>
<script>
async function checkSeasonPass(_) {
  return true; // TEMP: allow play
}
function logEvent(_) {}
/* ===== GLOBAL STATE (MUST BE FIRST) ===== */
window.nftByAssetId = {};
let selectedNFT = null;
let selectedUpgradePath = "";
let failsafeTimer = null;
let trackDuration = null;
let tracks = [];
let currentTrack = null;
let audio = null;
let notes = [];
let raf = null;
let suppressScoreSubmit = false;

let user = null;
let paidForThisTrack = false;
let walletType = "wax";
let anchorSession = null;

let score = 0;
let combo = 0;
let lastComboMilestone = 0;

let ssnEarnedThisRun = 0;
let nftWonThisRun = false;
let nftTxidThisRun = null;

let playing = false;
let ended = false;
let started = false;
let pausedForOrientation = false;

let restartAttempts = 0;
const MAX_RESTARTS = 3;
let isRestarting = false;
let allowFreeRestart = false;

let activeMultiplier = 1;
let multiplierTimeout = null;

let nftDropTriggered = false;

function updateUpgradeUI() {
  const upgradePathSelect = document.getElementById("upgradePath");
  const upgradeBtn = document.getElementById("upgradenft");

  if (!selectedNFT) {
    upgradePathSelect.disabled = true;
    upgradeBtn.disabled = true;
    return;
  }

  const level = Number(selectedNFT.level || 1);

  // üîí Max level lock
  if (level >= MAX_NFT_LEVEL) {
    upgradePathSelect.disabled = true;
    upgradeBtn.disabled = true;
    upgradeBtn.textContent = "Max Level";
    return;
  }

  upgradePathSelect.disabled = false;
  upgradeBtn.disabled = !selectedUpgradePath;
  upgradeBtn.textContent = "Upgrade NFT";

  updateNFTLevelBadge(selectedNFT);
}


function getUpgradeCost(level, path) {
  if (level === 1) return path === "both" ? 4000 : 2000;
  if (level === 2) return path === "both" ? 6000 : 3000;
  if (level === 3) return path === "both" ? 10000 : 5000;
  return Infinity;
}

function showUpgradeOverlay(text = "UPGRADING NFT‚Ä¶") {
  const o = document.getElementById("upgradeOverlay");
  o.querySelector(".upgrade-text").textContent = text;
  o.style.display = "flex";
}

function hideUpgradeOverlay() {
  const o = document.getElementById("upgradeOverlay");
  o.style.display = "none";
}

function upgradeSuccessFlash(text = "UPGRADE COMPLETE!") {
  const o = document.getElementById("upgradeOverlay");
  const t = o.querySelector(".upgrade-text");

  t.textContent = text;
  o.classList.add("upgrade-success");

  setTimeout(() => {
    o.classList.remove("upgrade-success");
    hideUpgradeOverlay();
  }, 900);
}

const upgradePathSelect = document.getElementById("upgradePath");

upgradePathSelect.onchange = (e) => {
  selectedUpgradePath = e.target.value;
updateUpgradeUI();
};

/* ===== NFT LOAD ===== */
async function loadNFTs() {
  const res = await authedFetch(
    "https://aquacejuyhtqdekdciql.supabase.co/functions/v1/scan-wallet-nfts",
    { user }
  );

  const data = await res.json();

  tracks = Array.isArray(data.tracks) ? data.tracks : [];

  // üîë Build asset_id ‚Üí NFT map
  window.nftByAssetId = {};
  tracks.forEach(nft => {
    if (nft.asset_id) {
      window.nftByAssetId[nft.asset_id] = nft;
    }
  });

  if (!tracks.length) {
    trackSelect.disabled = true;
    startBtn.disabled = true;
    return;
  }

  tracks.sort((a, b) =>
    a.name.localeCompare(b.name, undefined, { sensitivity: "base" })
  );

  trackSelect.innerHTML = "";

  tracks.forEach((t, i) => {
    const o = document.createElement("option");
    o.value = i;
    o.textContent = t.name;
    trackSelect.appendChild(o);
  });

  currentTrack = tracks[0];

  selectedNFT = currentTrack.asset_id
    ? window.nftByAssetId[currentTrack.asset_id]
    : null;

  updateNFTLevelBadge(selectedNFT);
  updateUpgradeUI();
  applyTrackVisuals();

  trackSelect.disabled = false;
  startBtn.disabled = false;

  await loadLeaderboard();
}


const rescanBtn = document.getElementById("rescanBtn");

rescanBtn.onclick = async () => {
  if (!user) return;

  rescanBtn.disabled = true;
  rescanBtn.textContent = "Scanning‚Ä¶";

  try {
    // Clear current state
    tracks = [];
    trackSelect.innerHTML = "";
    trackSelect.disabled = true;
    startBtn.disabled = true;

    await loadNFTs(); // üî• reuse existing logic

  } catch (err) {
    console.error("NFT rescan failed:", err);
    alert("Failed to re-scan wallet. Please try again.");
  } finally {
    rescanBtn.textContent = "Re-scan Wallet";
    rescanBtn.disabled = false;
  }
};

let SEASON_ID = localStorage.getItem("season_id") || "season1";
function isMobileDevice() {
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

function makeNonce(len = 10) {
  const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
  let out = "";
  for (let i = 0; i < len; i++) {
    out += chars[(Math.random() * chars.length) | 0];
  }
  return out;
}

// ===== KEYBOARD INPUT =====
const KEY_TO_LANE = {
  a: 0,
  s: 1,
  d: 2,
  f: 3,
  g: 4
};

document.addEventListener("visibilitychange", () => {
  if (document.hidden && playing && !ended) {
    endGame("visibility");
  }
});

window.addEventListener("keydown", (e) => {
  if (!playing || ended) return;

  const key = e.key.toLowerCase();
  if (key in KEY_TO_LANE) {
    e.preventDefault();
    hitLane(KEY_TO_LANE[key]);
  }
});
function pauseForOrientation(){
  if (!playing || pausedForOrientation) return;

  pausedForOrientation = true;

  // Pause audio/video
  if (audio && !audio.paused) audio.pause();
  if (!bgVideo.paused) bgVideo.pause();

  // Stop game loop
  cancelAnimationFrame(raf);
}

function resumeFromOrientation(){
  if (!playing || !pausedForOrientation) return;

  pausedForOrientation = false;

  // Resume audio/video
  if (audio) audio.play().catch(()=>{});
  if (bgVideo.src) bgVideo.play().catch(()=>{});

  // Resume loop
  loop();
}
let gameStartTime = 0;

async function triggerNFTClaim() {
  try {
await authedFetch(
  "https://aquacejuyhtqdekdciql.supabase.co/functions/v1/new-nft-drop", {
    user,
    track: currentTrack.name,
    season: SEASON_ID,
    hit: "sublime"
  }
);

spawnNFTConfetti();
nftWonThisRun = true;
  } catch (err) {
    console.warn("NFT claim failed silently");
  }
}

const lanes = document.getElementById("lanes");
const MAX_NFT_LEVEL = 4;
const ssnEl = document.getElementById("ssnEl");
const game = document.getElementById("game");
const hitLine = document.getElementById("hitLine");
const gameOver = document.getElementById("gameOver");
const bg = document.getElementById("bg");
const bgVideo = document.getElementById("bgVideo");
const flash = document.getElementById("flash");
const txLink = document.getElementById("txLink");

const loginBtn = document.getElementById("loginBtn");
const startBtn = document.getElementById("startBtn");
const trackSelect = document.getElementById("trackSelect");

const userLabel = document.getElementById("userLabel");
const scoreEl = document.getElementById("scoreEl");
const comboEl = document.getElementById("comboEl");
const multiplier = document.getElementById("multiplier");
multiplier.classList.add("x1");
const lbList = document.getElementById("lbList");
const finalScore = document.getElementById("finalScore");
const seasonResetBtn = document.getElementById("seasonResetBtn");
const payStatus = document.getElementById("payStatus");
const payBtn = document.getElementById("payBtn");
const anchorLoginBtn = document.getElementById("anchorLoginBtn");
const restartCounterEl = document.getElementById("restartCounter");
const clearTrackBtn = document.getElementById("clearTrackBtn");

function publicFetch(url, body) {
  return fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });
}

function authedFetch(url, body) {
  if (!window.sessionToken) {
    throw new Error("No session token ‚Äì user not authenticated");
  }

  return fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${window.sessionToken}`
    },
    body: JSON.stringify(body)
  });
}

function resetWalletState() {
  user = null;
  walletType = "wax";
  anchorSession = null;

  loginBtn.disabled = false;
  anchorLoginBtn.disabled = false;

  loginBtn.style.opacity = "1";
  anchorLoginBtn.style.opacity = "1";

  const badge = document.getElementById("walletBadge");
  badge.style.display = "none";
}

function renderLeaderboard(rows = []) {
  lbList.innerHTML = "";

  if (!rows.length) {
    lbList.innerHTML = `<div class="lb-empty">No scores yet</div>`;
    return;
  }

  rows.forEach(r => {
    const el = document.createElement("div");
    el.className = "lb-row";
    el.innerHTML = `<span>${r.user_account}</span><span>${r.score}</span>`;
    lbList.appendChild(el);
  });
}

function updateAdminUI() {
  if (ADMINS.includes(user)) {
    clearTrackBtn.style.display = "inline-block";
  } else {
    clearTrackBtn.style.display = "none";
  }
}
const isTelegram = /Telegram/i.test(navigator.userAgent);

if (isTelegram && isMobileDevice()) {
  alert("For best gameplay, tap ‚ãÆ and open in your browser");
}

const rotateHint = document.getElementById("rotateHint");

function getHitLineY() {
  const gameRect = game.getBoundingClientRect();
  const hitRect = hitLine.getBoundingClientRect();
  return hitRect.top - gameRect.top;
}

function lockWalletUI(type) {
  // Disable both login buttons
  loginBtn.disabled = true;
  anchorLoginBtn.disabled = true;

  loginBtn.style.opacity = "0.4";
  anchorLoginBtn.style.opacity = "0.4";

  loginBtn.style.cursor = "not-allowed";
  anchorLoginBtn.style.cursor = "not-allowed";

  // Wallet badge
  const badge = document.getElementById("walletBadge");
  badge.style.display = "inline-block";

  if (type === "anchor") {
    badge.textContent = "ANCHOR";
    badge.style.background = "#2563eb";
    badge.style.color = "#fff";
  } else {
    badge.textContent = "WAX";
    badge.style.background = "#facc15";
    badge.style.color = "#000";
  }
}

function showPayRequired() {
  payBtn.disabled = false;
  payBtn.style.display = "inline-block";
  payStatus.textContent = "Pay 100 SSN for this track";
  payStatus.style.color = "#facc15";
}

function updateRestartCounter() {
  if (ADMINS.includes(user)) {
    restartCounterEl.textContent = "Unlimited restarts (Admin)";
    restartCounterEl.style.opacity = "0.6";
    return;
  }

  const remaining = Math.max(0, MAX_RESTARTS - restartAttempts);
  restartCounterEl.textContent = `Restarts left: ${remaining} / ${MAX_RESTARTS}`;
  restartCounterEl.style.opacity = remaining === 0 ? "0.3" : "0.8";
}

function forceUnmuteMedia() {
  if (audio) {
    audio.muted = false;
    audio.volume = 1;
  }

  if (bgVideo) {
    bgVideo.muted = false;
    bgVideo.volume = 1;
  }
}

function checkOrientation(){
  if (!rotateHint) return;

  const isMobile = window.innerWidth <= 768;
  const isPortrait = window.matchMedia("(orientation: portrait)").matches;

  const shouldShow = isMobile && isPortrait;

  rotateHint.style.display = shouldShow ? "flex" : "none";

  if (playing) {
    if (shouldShow) {
      pauseForOrientation();
    } else {
      resumeFromOrientation();
    }
  }

  document.documentElement.style.setProperty(
    "--vh",
    window.innerHeight * 0.01 + "px"
  );
}checkOrientation();

window.addEventListener("orientationchange", () => {
  setTimeout(checkOrientation, 300);
});

window.addEventListener("resize", () => {
  setTimeout(checkOrientation, 300);
});

/* ===== GAME PASS CONFIG ===== */
const SEASON_PASS_TEMPLATE_ID = "123456"; // üëà replace later
const ENABLE_SEASON_PASS = false; // üîí toggle season pass on/off

/* ===== IPFS FALLBACK SETUP ===== */
const IPFS_GATEWAYS = [
  "https://rhythmgame.sublime-sound.com/ipfs/",
  "https://cloudflare-ipfs.com/ipfs/",
  "https://ipfs.io/ipfs/"
];

function resolveIPFS(cid, index = 0) {
  if (!cid) return "";
  return IPFS_GATEWAYS[index] + cid;
}

function normalizeIPFS(value) {
  if (!value) return null;

  if (Array.isArray(value)) value = value[0];

  if (typeof value === "object" && value.ipfs) {
    return value.ipfs;
  }

  if (typeof value === "string") {
    if (value.startsWith("ipfs://")) {
      return value.replace("ipfs://", "");
    }

    const idx = value.indexOf("/ipfs/");
    if (idx !== -1) {
      return value.substring(idx + 6);
    }

    return value; // already CID
  }

  return null;
}

function loadAudioWithFallback(cid, onReady) {
  let index = 0;
  const audio = new Audio();

  function tryLoad() {
    audio.src = resolveIPFS(cid, index);
    audio.onloadedmetadata = () => onReady(audio);
    audio.onerror = () => {
      index++;
      if (index < IPFS_GATEWAYS.length) {
        tryLoad();
      } else {
        console.error("Audio failed on all gateways:", cid);
      }
    };
  }

  tryLoad();
}

function loadVideoWithFallback(cid, videoEl, onReady) {
  let index = 0;

  function tryLoad() {
    const url = resolveIPFS(cid, index);
    videoEl.src = url;
    videoEl.load();

    videoEl.onloadedmetadata = () => onReady();
    videoEl.onerror = () => {
      index++;
      if (index < IPFS_GATEWAYS.length) {
        tryLoad();
      } else {
        console.error("Video failed on all gateways:", cid);
      }
    };
  }

  tryLoad();
}

/* ===== CONFIG ===== */
const MAX_RUN_SECONDS = 180; // or track length safety cap
const START_DELAY = 5;
const COLLECTION="sublimesound";
const ADMINS = ["fs1r2.wam"];
const SSN_CONTRACT="metatoken.gm";
const SSN_SYMBOL="SSN";
const SSN_AMOUNT="100.00000000";
const SSN_RECEIVER="a1hd.wam";
const LANES=5;
const NOTE_SPEED=260;
const HIT_WINDOW=0.18;

function getVisualSpeedMultiplier(now, duration) {
  if (!duration) return 1;

  const progress = Math.min(1, Math.max(0, now / duration));

  // MUCH gentler curve
  const min = 0.95;  // almost normal start
  const max = 1.10;  // slight challenge increase

  return min + (max - min) * progress;
}

/* ===== WAX ===== */
const wax=new waxjs.WaxJS({rpcEndpoint:"https://api.waxsweden.org"});
restartAttempts = 0;
updateRestartCounter();

// ===== ANCHOR SETUP =====
const anchorLink = new AnchorLink({
  transport: new window.AnchorLinkBrowserTransport(),
  chains: [{
    chainId: "1064487b3cd1a897ce03ae5b6a865651747e2e152090f99c1d19d44e01aea5a4",
    nodeUrl: "https://api.waxsweden.org"
  }]
});
restartAttempts = 0;
updateRestartCounter();

/* ===== SSN PAYMENT HANDLER ===== */
payBtn.onclick = async () => {
  if (!user) {
    alert("Please connect WAX first");
    return;
  }

  if (paidForThisTrack) return;

  try {
    payStatus.textContent = "Processing payment...";
    payStatus.style.color = "#facc15";
    payBtn.disabled = true;

let result;

if (walletType === "anchor") {
  if (!anchorSession) {
    throw new Error("Anchor session missing");
  }

  const actor = anchorSession.auth.actor.toString();

  result = await anchorSession.transact(
    {
      actions: [{
        account: SSN_CONTRACT,
        name: "transfer",
        authorization: [{
          actor,
          permission: "active"
        }],
        data: {
          from: actor,
          to: SSN_RECEIVER,
          quantity: `${SSN_AMOUNT} ${SSN_SYMBOL}`,
          memo: `Rhythm Master ‚Äì ${currentTrack?.name || "Track"}`
        }
      }]
    },
    {
      blocksBehind: 3,
      expireSeconds: 120
    }
  );

} else {
  result = await wax.api.transact(
    {
      actions: [{
        account: SSN_CONTRACT,
        name: "transfer",
        authorization: [{
          actor: user,
          permission: "active"
        }],
        data: {
          from: user,
          to: SSN_RECEIVER,
          quantity: `${SSN_AMOUNT} ${SSN_SYMBOL}`,
          memo: `Rhythm Master ‚Äì ${currentTrack?.name || "Track"}`
        }
      }]
    },
    {
      blocksBehind: 3,
      expireSeconds: 120
    }
  );
}
    paidForThisTrack = true;
    startBtn.disabled = false;
    payBtn.disabled = true;

    payStatus.textContent = "Payment successful ‚úî";
    payStatus.style.color = "#22d3ee";

const txid =
  result?.transaction_id ||
  result?.processed?.id;

if (txLink && txid) {
  txLink.href = `https://waxblock.io/transaction/${txid}`;
  txLink.style.display = "inline";
}
logEvent({
  type: "ssn_payment",
  wallet: walletType,
  track: currentTrack?.name,
  txid
});

  } catch (err) {
    // üî• IMPORTANT FIX
    console.warn("WaxJS error (may still be successful):", err);

    // If WaxJS threw but tx already went through ‚Üí allow play
    paidForThisTrack = true;
    startBtn.disabled = false;
    payBtn.disabled = true;

    payStatus.textContent = "Payment confirmed ‚úî";
    payStatus.style.color = "#22d3ee";
  }
};

/* ===== BUILD LANES ===== */
for(let i=0;i<LANES;i++){
  const l=document.createElement("div");
  l.className="lane";

l.addEventListener("pointerdown", e => {
  if (!playing || ended) return;

  // Only prevent default while playing
  e.preventDefault();

  hitLane(i);
});

  const k=document.createElement("div");
  k.className="key";
  k.textContent=["A","S","D","F","G"][i];
  l.appendChild(k);
  lanes.appendChild(l);
}

anchorLoginBtn.onclick = async () => {
  try {
    const identity = await anchorLink.login("Rhythm Master");
    anchorSession = identity.session;
    user = anchorSession.auth.actor.toString();

    const res = await publicFetch(
      "https://aquacejuyhtqdekdciql.supabase.co/functions/v1/auth-session",
      { user, wallet: "anchor" }
    );

    if (!res.ok) throw new Error("Auth session failed");

    const data = await res.json();
    window.sessionToken = data.token;

    lockWalletUI("anchor");
    updateAdminUI();
    await loadNFTs();

  } catch (err) {
    console.error("Anchor login failed", err);
    resetWalletState();
    alert("Anchor login failed");
  }
};

seasonResetBtn.onclick = async () => {
  if (!ADMINS.includes(user)) return;

  const next = prompt(
    "Enter new season ID (example: season2, s2025_01)"
  );

  if (!next) return;

  SEASON_ID = next.trim();

localStorage.setItem("season_id", SEASON_ID);

  alert(`New season started: ${SEASON_ID}`);

  // Reload leaderboard for current track
  await loadLeaderboard();
};

clearTrackBtn.onclick = async () => {
  if (!ADMINS.includes(user)) return;

  if (!currentTrack) {
    alert("No track selected");
    return;
  }

  const ok = confirm(
    `Clear leaderboard for:\n\n${currentTrack.name}\n\nSeason: ${SEASON_ID}`
  );

  if (!ok) return;

  await authedFetch(
    "https://aquacejuyhtqdekdciql.supabase.co/functions/v1/clear-track-leaderboard", 
{
        track: currentTrack.name,
        season: SEASON_ID
    }
  );

  await loadLeaderboard();
};

loginBtn.onclick = async () => {
  try {
    await wax.login();
    user = wax.userAccount;

    const res = await publicFetch(
      "https://aquacejuyhtqdekdciql.supabase.co/functions/v1/auth-session",
      { user, wallet: "wax" }
    );

    if (!res.ok) throw new Error("Auth session failed");

    const data = await res.json();
    window.sessionToken = data.token;

    lockWalletUI("wax");
    updateAdminUI();
    await loadNFTs();

  } catch (err) {
    console.error("WAX login failed", err);
    resetWalletState();
    alert("Login failed");
  }
};

const upgradeBtn = document.getElementById("upgradenft");

function updateNFTLevelBadge(nft) {
  const badge = document.getElementById("nftLevelBadge");
  if (!nft) {
    badge.style.display = "none";
    return;
  }

  const level = Number(nft.level || 1);
  badge.textContent = `LV ${level}`;
  badge.className = `nft-level-badge level-${level}`;
  badge.style.display = "inline-block";
}

trackSelect.onchange = () => {
  const index = Number(trackSelect.value);
  if (!tracks[index]) return;

  currentTrack = tracks[index];
  applyTrackVisuals();
  loadLeaderboard();

  selectedUpgradePath = "";
  document.getElementById("upgradePath").value = "";

selectedNFT = currentTrack.asset_id
  ? window.nftByAssetId[currentTrack.asset_id]
  : null;

updateNFTLevelBadge(selectedNFT);
updateUpgradeUI();
};

upgradeBtn.onclick = async () => {
  if (!user || !selectedNFT || !selectedUpgradePath) {
    alert("Select NFT and upgrade path");
    return;
  }

  upgradeBtn.disabled = true;
  showUpgradeOverlay();

  try {
    const res = await authedFetch(
      "https://aquacejuyhtqdekdciql.supabase.co/functions/v1/upgrade-nft",
      {
        user,
        asset_id: selectedNFT.asset_id,
        upgrade_path: selectedUpgradePath
      }
    );

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Upgrade failed");

    upgradeSuccessFlash("NFT UPGRADED!");
    showComboCelebration("NFT UPGRADED!", "combo-nft");

    setTimeout(loadNFTs, 1200);
  } catch (err) {
    hideUpgradeOverlay();
    alert(err.message);
  } finally {
    upgradeBtn.disabled = false;
  }
};

function enterGameFullscreen() {
  const el = document.getElementById("game");
  if (!el) return;

  if (el.requestFullscreen) {
    el.requestFullscreen();
  } else if (el.webkitRequestFullscreen) {
    el.webkitRequestFullscreen(); // iOS Safari
  }
}

function exitGameFullscreen() {
  if (document.fullscreenElement || document.webkitFullscreenElement) {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    }
  }
}

/* ===== GAME START ===== */
startBtn.onclick = () => {
ssnEl.textContent = "0";
nftWonThisRun = false;
nftTxidThisRun = null; // ‚úÖ ADD THIS
nftDropTriggered = false;
  // üî• ENTER FULLSCREEN FOR GAMEPLAY
if (isMobileDevice()) {
  enterGameFullscreen();

  if (screen.orientation && screen.orientation.lock) {
    screen.orientation.lock("landscape").catch(() => {});
  }
}

// ‚úÖ PAID RUN ONLY resets restart attempts
if (!allowFreeRestart) {
  restartAttempts = 0;
  suppressScoreSubmit = false;
  updateRestartCounter();
}

if (!paidForThisTrack && !allowFreeRestart) {
  alert("Please pay 100 SSN to play this track");
  return;
}

  playing = true;

game.style.pointerEvents = "auto";

if (failsafeTimer) {
  clearTimeout(failsafeTimer);
  failsafeTimer = null;
}

failsafeTimer = setTimeout(() => {
  if (playing && !ended) {
    console.warn("‚è± Forced game end (failsafe)");
    endGame("failsafe");
  }
}, MAX_RUN_SECONDS * 1000);

  ended = false;
allowFreeRestart = false;
isRestarting = false;

// Restore restart button visibility
const restartBtn = document.querySelector('#gameOver button.secondary');
if (restartBtn) restartBtn.style.display = "inline-block";

 game.focus();

loginBtn.disabled = true;
loginBtn.style.opacity = "0.4";
loginBtn.style.cursor = "not-allowed";

forceUnmuteMedia(); // üîä CRITICAL: allow sound

gameStartTime = performance.now() / 1000;

  startBtn.disabled = true;
  trackSelect.disabled = true;

  score=0; combo=0;
  scoreEl.textContent=0;
  comboEl.textContent=0;

  notes=[];

if (currentTrack.videoCID) {
  bgVideo.currentTime = 0;
}

if (currentTrack.audioCID) {
  loadAudioWithFallback(currentTrack.audioCID, (loadedAudio) => {
    audio = loadedAudio;

    spawnNotes();
    audio.play().catch(()=>{});
    loop();
  });
}

// üé• VIDEO-ONLY TRACK START (FIXED)
if (!currentTrack.audioCID && currentTrack.videoCID) {
  bgVideo.currentTime = 0;

function startVideoGame() {
  if (started) return;
  started = true;

  forceUnmuteMedia(); // üîä ensure sound

  spawnNotes();
  bgVideo.play().catch(() => {});
  loop();
}

  bgVideo.play().then(() => {
    spawnNotes();
    loop();
  }).catch(err => {
    console.warn("Video play blocked, retrying...", err);

    // Retry after small delay (IPFS gateways can lag)
    setTimeout(() => {
      bgVideo.play().then(() => {
        spawnNotes();
        loop();
      });
    }, 500);
  });
}
};

/* ===== GAME LOOP ===== */
function spawnNotes() {
  notes = [];

  const duration =
    audio?.duration ??
    bgVideo?.duration ??
    60;

  for (let t = 1; t < duration; t += 0.6) {
    const lane = Math.floor(Math.random() * LANES);
    const el = document.createElement("div");

    const roll = Math.random();
    let type = "normal";

    if (roll < 0.005) type = "nft";
    else if (roll < 0.013) type = "ssn100";
    else if (roll < 0.023) type = "ssn10";
    else if (roll < 0.033) type = "ssn1";
    else if (roll < 0.093) type = "x3";
    else if (roll < 0.143) type = "x2";

    el.className = "note";

    if (type === "x2") {
      el.classList.add("mult-x2");
      el.dataset.label = "x2";
    }
    else if (type === "x3") {
      el.classList.add("mult-x3");
      el.dataset.label = "x3";
    }
    else if (type === "nft") {
      el.classList.add("mult-nft");
      el.dataset.label = "NFT";
    }
    else if (type.startsWith("ssn")) {
      el.classList.add("ssn");
      el.dataset.label =
        type === "ssn100" ? "100 √ó SSN" :
        type === "ssn10"  ? "10 √ó SSN"  :
                            "1 √ó SSN";
    }

    lanes.children[lane].appendChild(el);

    notes.push({
      time: t + START_DELAY,
      lane,
      el,
      hit: false,
      type
    });
  }
}

function loop() {
  if (!playing || pausedForOrientation) return;

  let now;

  // ‚úÖ FIRST: compute time
  if (audio && !audio.paused) {
    now = audio.currentTime;
  } else if (bgVideo && !bgVideo.paused && bgVideo.currentTime > 0) {
    now = bgVideo.currentTime;
  } else {
    now = performance.now() / 1000 - gameStartTime;
  }

  // ‚úÖ SECOND: end condition
  if (
    playing &&
    !ended &&
    (
      (audio && audio.duration && now >= audio.duration - 0.05) ||
      (!audio && bgVideo && bgVideo.duration && now >= bgVideo.duration - 0.05)
    )
  ) {
    endGame("natural");
    return;
  }

  const duration =
    audio?.duration ??
    bgVideo?.duration ??
    60;

  const speedMult = getVisualSpeedMultiplier(now, duration);
  const hitY = getHitLineY();

  notes.forEach(n => {
    if (!n.hit) {
      const y = hitY - (n.time - now) * NOTE_SPEED * speedMult;

      if (y < -60 || y > game.offsetHeight + 60) {
        n.el.classList.remove("visible");
        return;
      }

      n.el.classList.add("visible");
      n.el.style.top = y + "px";
    }
  });

  raf = requestAnimationFrame(loop);
}
function pulseLane(i, perfect=false){
  const lane = lanes.children[i];
  lane.classList.remove("hit","perfect");
  void lane.offsetWidth;
  lane.classList.add(perfect ? "perfect" : "hit");
  setTimeout(()=>lane.classList.remove("hit","perfect"),120);
}

function shakeGame(){
  game.classList.remove("shake");
  void game.offsetWidth;
  game.classList.add("shake");
}

function spawnNFTConfetti() {
  for (let i = 0; i < 40; i++) {
    const c = document.createElement("div");
    c.style.position = "fixed";
    c.style.left = Math.random() * 100 + "vw";
    c.style.top = "-10px";
    c.style.width = "8px";
    c.style.height = "14px";
    c.style.background = "#22c55e";
    c.style.opacity = "0.9";
    c.style.borderRadius = "2px";
    c.style.zIndex = "99999";
    c.style.transform = `rotate(${Math.random()*360}deg)`;

    document.body.appendChild(c);

    const fall = c.animate(
      [
        { transform: "translateY(0)", opacity: 1 },
        { transform: `translateY(${window.innerHeight + 40}px)`, opacity: 0 }
      ],
      {
        duration: 1600 + Math.random() * 800,
        easing: "ease-out"
      }
    );

    fall.onfinish = () => c.remove();
  }
}

function spawnSpark(i, acc){
  const r = lanes.children[i].getBoundingClientRect();
  const y = hitLine.getBoundingClientRect().top;
  const size = acc > 0.85 ? 420 : 200;

  const s = document.createElement("div");
  s.className = "spark";
  s.style.width = s.style.height = size + "px";
  s.style.left = (r.left + r.width/2 - size/2) + "px";
  s.style.top = (y - size/2) + "px";
  s.style.background =
    acc > 0.85
      ? "radial-gradient(circle,#fff,#ff5fd2,transparent 70%)"
      : "radial-gradient(circle,#fff,#22d3ee,transparent 70%)";

  document.body.appendChild(s);
  setTimeout(()=>s.remove(),400);
}

/* ===== HIT ===== */
function hitLane(i){
game.focus();
  if(!playing || ended) return;

  const now =
    audio?.currentTime ??
    bgVideo?.currentTime ??
    performance.now() / 1000;

  let best = null, bd = 999;

  for(const n of notes){
    if(n.hit || n.lane !== i) continue;
    const d = Math.abs(n.time - now);
    if(d < bd){ bd = d; best = n; }
  }

const HIT_BUFFER = 0.03; // 30ms forgiveness (mobile safe)

if (best && bd <= HIT_WINDOW + HIT_BUFFER) {

    // multiplier pickup
    if(best.type === "x2") activateMultiplier(2, 5);
    else if(best.type === "x3") activateMultiplier(3, 3);

    best.hit = true;
best.el.remove();

const acc = 1 - bd / HIT_WINDOW;

let judgement = "ok";

if (acc >= 0.85) judgement = "sublime";
else if (acc >= 0.65) judgement = "great";
else judgement = "ok";

// üéÅ NFT DROP
if (best.type === "nft" && judgement === "sublime" && !nftDropTriggered) {
  nftDropTriggered = true;

authedFetch(
  "https://aquacejuyhtqdekdciql.supabase.co/functions/v1/new-nft-drop",
  {
    user,
    track: currentTrack.name,
    season: SEASON_ID,
    hit: judgement
  }
)
.then(res => res.json())
  .then(data => {
    if (data?.drop) {
      nftWonThisRun = true;
      nftTxidThisRun = data.txid || null; // ‚úÖ STORE TXID
      spawnNFTConfetti();
      showComboCelebration("NFT WON!", "combo-nft");
    }
  })
  .catch(err => {
    console.warn("NFT drop failed", err);
  });
}

// üí∞ SSN DROPS
if (judgement === "sublime" && best.type?.startsWith("ssn")) {
  let amount = 0;

  if (best.type === "ssn1") amount = 1;
  if (best.type === "ssn10") amount = 10;
  if (best.type === "ssn100") amount = 100;

if (amount > 0) {
  ssnEarnedThisRun += amount; // üîë ACCUMULATE
ssnEl.textContent = ssnEarnedThisRun;
  showComboCelebration(`+${amount} SSN!`, "combo-20");
}
}

async function requestSSNPayout(amount, memo) {
  await authedFetch(
    "https://aquacejuyhtqdekdciql.supabase.co/functions/v1/ssn-reward",
    { user, memo }
  );
}

/* ===== COMBO LOGIC ===== */
// ‚úÖ GREAT + SUBLIME build combo
if (judgement === "sublime" || judgement === "great") {
  combo++;

  if (combo >= 50 && lastComboMilestone < 50) {
    showComboCelebration("RHYTHM MASTER!", "combo-50");
    lastComboMilestone = 50;
  } else if (combo >= 30 && lastComboMilestone < 30) {
    showComboCelebration("SUBLIME COMBO!", "combo-30");
    lastComboMilestone = 30;
  } else if (combo >= 20 && lastComboMilestone < 20) {
    showComboCelebration("AMAZING COMBO!", "combo-20");
    lastComboMilestone = 20;
  } else if (combo >= 10 && lastComboMilestone < 10) {
    showComboCelebration("GREAT COMBO!", "combo-10");
    lastComboMilestone = 10;
  } else if (combo >= 5 && lastComboMilestone < 5) {
    showComboCelebration("NICE COMBO!", "combo-5");
    lastComboMilestone = 5;
  }
} else {
  combo = 0;
  lastComboMilestone = 0;
}
score += Math.floor(
  judgement === "sublime"
    ? 1000 * acc * activeMultiplier
    : judgement === "great"
    ? 700 * acc * activeMultiplier
    : 400 * acc
);

// Visual feedback
pulseLane(i, judgement === "sublime");
spawnSpark(i, acc);
if (judgement === "sublime") shakeGame();

showJudge(judgement);

  } else {
    combo = 0;
lastComboMilestone = 0;
    pulseLane(i, false);
    showJudge(false, true);
  }

  scoreEl.textContent = score;
  comboEl.textContent = combo;
}
function activateMultiplier(value, seconds){
  activeMultiplier = value;

  // üîÑ reset classes
  multiplier.className = "";
  multiplier.classList.add(value === 2 ? "x2" : "x3");

  multiplier.textContent = "x" + value;

  // Flash overlay (already working)
  flash.className = "";
  void flash.offsetWidth;
  flash.classList.add("active", value === 2 ? "x2" : "x3");

  if(multiplierTimeout) clearTimeout(multiplierTimeout);

  multiplierTimeout = setTimeout(()=>{
    activeMultiplier = 1;

    multiplier.className = "x1";
    multiplier.textContent = "x1";
  }, seconds * 1000);
}
/* ===== JUDGE ===== */
function showJudge(type, miss = false) {
  const j = document.createElement("div");
  j.className = "judge";

  if (miss) {
    j.textContent = "MISS";
    j.classList.add("miss");
  }
  else if (type === "sublime") {
    j.textContent = "SUBLIME!";
    j.classList.add("sublime");
  }
  else if (type === "great") {
    j.textContent = "GREAT!";
    j.classList.add("great");
  }
  else {
    j.textContent = "OK";
    j.classList.add("ok");
  }

  game.appendChild(j);
  setTimeout(() => j.remove(), 600);
}

function showComboCelebration(text, className) {
  const el = document.createElement("div");
  el.className = `combo-celebrate ${className}`;
  el.textContent = text;

  document.getElementById("comboOverlay").appendChild(el);

  setTimeout(() => el.remove(), 2000);
}

/* ===== END ===== */
function clearNotes() {
  // 1Ô∏è‚É£ Remove all tracked notes
  notes.forEach(n => {
    if (n.el && n.el.parentNode) {
      n.el.remove();
    }
  });
  notes.length = 0;

  // 2Ô∏è‚É£ HARD DOM CLEANUP (critical)
  document.querySelectorAll("#lanes .note").forEach(el => el.remove());

  // 3Ô∏è‚É£ Clear combo overlays just in case
  document.getElementById("comboOverlay").innerHTML = "";
}

async function endGame(reason = "natural") {
if (failsafeTimer) {
  clearTimeout(failsafeTimer);
  failsafeTimer = null;
}
if (ended) return;
started = false;
if (!playing) return;

ended = true;
playing = false;
cancelAnimationFrame(raf);
clearNotes();

  if (reason === "visibility") {
    alert("Game paused because the tab lost focus. Run ended.");
  }

  // Exit fullscreen safely
  if (isMobileDevice()) {
    exitGameFullscreen();
    if (screen.orientation?.unlock) {
      screen.orientation.unlock();
    }
  }

  anchorLoginBtn.disabled = false;
  pausedForOrientation = false;
  rotateHint.style.display = "none";

  activeMultiplier = 1;
  if (multiplierTimeout) clearTimeout(multiplierTimeout);

  cancelAnimationFrame(raf);
  if (audio) audio.pause();
  if (bgVideo) bgVideo.pause();

  clearNotes();

lanes.style.pointerEvents = "none";
lanes.style.pointerEvents = "auto";
gameOver.style.pointerEvents = "auto";

  finalScore.textContent = score;

document.getElementById("ssnEarned").textContent =
  `SSN Earned: ${ssnEarnedThisRun}`;

  // üéÅ NFT badge
const nftBadge = document.getElementById("nftWonBadge");
const nftTxLinkEl = document.getElementById("nftTxLink");

if (nftWonThisRun) {
  nftBadge.style.display = "block";

  if (nftTxidThisRun && nftTxLinkEl) {
    nftTxLinkEl.href = `https://waxblock.io/transaction/${nftTxidThisRun}`;
    nftTxLinkEl.textContent = "View NFT Transaction";
    nftTxLinkEl.style.display = "inline-block";
  }
} else {
  nftBadge.style.display = "none";
  if (nftTxLinkEl) nftTxLinkEl.style.display = "none";
}

  // üí∞ SSN settlement
if (ssnEarnedThisRun > 0) {
  const nonce = makeNonce();

  const memo =
    `SSN_CLAIM:${nonce}:${ssnEarnedThisRun}:${SEASON_ID}:${currentTrack.name}`;

await authedFetch(
  "https://aquacejuyhtqdekdciql.supabase.co/functions/v1/settle-ssn", {
    user,
    memo
  }
);
}

  ssnEarnedThisRun = 0;

  gameOver.style.display = "flex";
  restartCounterEl.style.opacity = "0.4";

  if (score > 0) {
    await submitScore();
    loadLeaderboard();
  }

  startBtn.disabled = false;
  trackSelect.disabled = false;
  allowFreeRestart = false;
}

function closeGameOver() {
  gameOver.style.display = "none";
  lanes.style.pointerEvents = "auto";

  // üö´ If we're restarting, DO NOTHING else
  if (allowFreeRestart || isRestarting) return;

  // ‚úÖ OK button path (normal end)
  allowFreeRestart = false;
  isRestarting = false;

  if (!ADMINS.includes(user)) {
    paidForThisTrack = false;
    startBtn.disabled = true;
    payBtn.disabled = false;

    payStatus.textContent = "Pay 100 SSN to play again";
    payStatus.style.color = "#facc15";
  }
}

/* ===== LEADERBOARD ===== */
function lbKey(){return `leaderboard_${SEASON_ID}_${currentTrack.name}`}
async function loadLeaderboard() {
  lbList.innerHTML = "";

const res = await authedFetch(
  "https://aquacejuyhtqdekdciql.supabase.co/functions/v1/load-leaderboard",
  {
    season: SEASON_ID,
    track: currentTrack.name
  }
);
  const data = await res.json();
  renderLeaderboard(data.rows);
}

async function submitScore() {
  if (!user || score <= 0) return;

  const res = await authedFetch(
    "https://aquacejuyhtqdekdciql.supabase.co/functions/v1/submit-score",
    {
      user,
      track: currentTrack.name,
      season: SEASON_ID,
      score,
      combo,
      asset_id: currentTrack.asset_id
    }
  );

  if (!res.ok) {
    console.warn("Score submit failed");
  }
}

function restartGame() {
  started = false;
  ended = true;
  playing = false;

  cancelAnimationFrame(raf);

  clearNotes();

  // Reset visuals
  document.getElementById("comboOverlay").innerHTML = "";
  document.querySelectorAll(".judge").forEach(j => j.remove());
  document.querySelectorAll(".spark").forEach(s => s.remove());

  if (audio) {
    audio.pause();
    audio.currentTime = 0;
  }

  bgVideo.pause();
  bgVideo.currentTime = 0;

  // ‚úÖ FREE RESTART
  allowFreeRestart = true;
  isRestarting = true;

  closeGameOver();
  clearNotes();

  ended = false;
  playing = false;

  if (audio) {
    audio.pause();
    audio.currentTime = 0;
  }

  startBtn.disabled = false;
  startBtn.click();
}
updateAdminUI();
</script>
</div>
</div>
<div id="upgradeOverlay" style="display:none">
  <div class="upgrade-core">
    <div class="upgrade-ring"></div>
    <div class="upgrade-text">UPGRADING NFT‚Ä¶</div>
  </div>
</div>
</body>
</html>