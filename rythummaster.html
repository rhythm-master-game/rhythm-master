<!doctype html>
<html lang="en">
<head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta charset="utf-8">
<title>Sublime Sounds ‚Äì Rhythm Master - Beta Testing Phase</title>
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
/>
<script src="https://notify.waxsweden.org/static/assets/waxjs.js"></script>
<script src="https://unpkg.com/anchor-link@3"></script>
<script src="https://unpkg.com/anchor-link-browser-transport@3"></script>



<style>
#comboOverlay {
  position: fixed;
  inset: 0;
  z-index: 2147483647; /* max safe z-index */
  pointer-events: none;
}
/* ===== COMBO CELEBRATIONS ===== */
.combo-celebrate {
  position: fixed; /* üîë was absolute */
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) scale(1);
  font-weight: 900;
  text-align: center;
  pointer-events: none;
  z-index: 99999; /* üî• above EVERYTHING */
  animation: comboPop 2s forwards, comboGlow 0.6s ease-out;
}

@keyframes comboGlow {
  0% { filter: brightness(1); }
  50% { filter: brightness(1.3); }
  100% { filter: brightness(1); }
}

.combo-5 {
  font-size: 36px;
  color: #22c55e; /* green */
  text-shadow: 0 0 12px rgba(34,197,94,0.9);
}

.combo-10 {
  font-size: 42px;
  color: #22d3ee;
  text-shadow: 0 0 14px rgba(34,211,238,0.9);
}

.combo-20 {
  font-size: 54px;
  color: #FF0000;
  text-shadow: 0 0 22px rgba(56,189,248,1);
}

.combo-30 {
  font-size: 68px;
  color: #ff5fd2;
  text-shadow:
    0 0 18px #ff5fd2,
    0 0 36px #ff5fd2;
}

.combo-50 {
  font-size: 84px;
  color: #facc15; /* gold */
  letter-spacing: 2px;
  text-shadow:
    0 0 18px #facc15,
    0 0 36px #facc15,
    0 0 64px rgba(250,204,21,0.9);
}

@keyframes comboPop {
  0%   { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
  15%  { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
  80%  { opacity: 1; }
  100% { opacity: 0; transform: translate(-50%, -50%) scale(1.25); }
}
body::before {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(5, 5, 16, 0.9); /* adjust opacity if needed */
  pointer-events: none;
  z-index: -1;
}

html, body {
  margin: 0;
  padding: 0;
  color: #fff;
  font-family: system-ui;

  background-color: #050510;

  background-repeat: no-repeat, no-repeat;

  background-position:
    top 20px left 20px,
    top 20px right 20px;

  background-size:
    260px auto,
    260px auto;
}
main{max-width:1300px;margin:auto;padding:14px}
h1{text-align:center}

* {
  -webkit-overflow-scrolling: touch;
}

#game,
#lanes,
.note,
.spark {
  will-change: transform;
}

html {
  height: 100%;
  overflow-y: auto;
}

body {
  height: auto;
}

#page {
  min-height: 100vh;
}


/* ===== AD SLOTS (CLEAN) ===== */
.ad-slot {
  height: 180px;
  border-radius: 12px;
  background: #020617;
  border: 1px dashed rgba(255,255,255,0.15);

  /* üî¥ REMOVE FLEX CENTERING */
  display: block;

  overflow: hidden;
  color: rgba(255,255,255,0.35);
  font-weight: 800;
  font-size: 14px;
}

.ad-slot.ad-image {
  padding: 0;
}

.ad-slot.ad-image a {
  display: block;
  width: 100%;
  height: 100%;
}

.ad-slot.ad-image img {
  display: block;
  width: 100%;
  height: 100%;
  object-fit: cover;   /* FULL BLEED */
}

/* üîí Lock gestures ONLY inside the game */
body.playing #game {
  touch-action: none;
}
/* Prevent scroll ONLY when interacting with the game */
#game {
  touch-action: manipulation;
}
#gameOver{
  z-index: 10;
  pointer-events: auto;
}

#gameOver button{
  pointer-events: auto;
}
#headerRow{
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 16px;
  margin: 8px 0 10px;
}

#bottomRow{
  display: grid;
  grid-template-columns: repeat(3, 1fr) 320px;
  grid-template-rows: repeat(2, 180px);
  gap: 14px;
  margin-top: 14px;
}

#lbLogoWrap{
  grid-column: 4;
  grid-row: 1 / span 2;
  display: flex;
  align-items: center;
  justify-content: center;

  background-color: #020617;
  border-radius: 14px;

  /* üî• LOGO AS BACKGROUND */
  background-image: url("img/rhythm-master-tr.png");
  background-repeat: no-repeat;
  background-position: center;
  background-size: contain;

  /* optional visual polish */
  filter: drop-shadow(0 0 18px rgba(236,72,153,0.45));
}

/* Logo */
#gameLogo{
  max-width: 260px;
  width: 100%;
  height: auto;
}
#titleRow{
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 16px;
  margin: 6px 0 10px;
}

/* Logo */
#titleLogo{
  max-width: 240px;   /* keeps it compact */
  width: 100%;
  height: auto;
}

/* UI */
button,select{
  padding:10px 14px;border-radius:8px;border:none;
  background:#ec4899;color:#fff;font-weight:700;cursor:pointer
}
button.secondary{background:#22d3ee;color:#000}
button.warn{background:#dc2626}
button:disabled{opacity:.4}

#top,#payment,#hud{
  display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:10px
}

#multiplier{
  padding:6px 16px;border-radius:999px;background:#111827
}
#multiplier.x2{background:#22d3ee;color:#000}
#multiplier.x4{background:#facc15;color:#000}
#multiplier.x8{background:#ec4899;color:#fff;box-shadow:0 0 20px #ec4899}

#layout{
  display:grid;
  grid-template-columns:1fr 320px;
  gap:14px;
  margin-top:14px;
}

/* GAME */
#game{
  position:relative;height:420px;border-radius:14px;
  background:#020617;overflow:hidden;outline:none
}
#game.shake{animation:shake .18s}
@keyframes shake{
  25%{transform:translate(-6px,4px)}
  50%{transform:translate(6px,-4px)}
  75%{transform:translate(-4px,-6px)}
}

#bg, #bgVideo{
  position:absolute;inset:0;
  width:100%;height:100%;
  object-fit:cover;
  opacity:.35;
  z-index:0;
}

#bg{background-size:cover;background-position:center}
#bgVideo{display:none}

#lanes{position:absolute;inset:0;display:flex;z-index:1}

.lane{
  width:20%;position:relative;cursor:pointer;
  border-left:1px solid rgba(255,255,255,.1);
  border-right:1px solid rgba(255,255,255,.1);
}
.lane.hit{background:rgba(34,211,238,.18)}
.lane.perfect{
  background:rgba(236,72,153,.35);
  box-shadow:inset 0 0 40px rgba(236,72,153,1)
}

.key{
  position:absolute;bottom:10px;left:50%;
  transform:translateX(-50%);
  font-size:26px;font-weight:900;opacity:.8
}

.note{
  position:absolute;
  top:-20px;
  left:10%;
  width:80%;
  height:16px;
  border-radius:8px;
  background:#ec4899;
}

.note.mult-x2,
.note.mult-x3{
  overflow: visible;          /* ‚úÖ allow text outside bar */
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
}

.note.mult-x2{
  background:#facc15;
  color:#fff;                 /* ‚úÖ X2 text now WHITE */
}

.note.mult-x3{
  background:#dc2626;
  color:#fff;
}


/* BIG TEXT */
.note.mult-x2::after,
.note.mult-x3::after{
  content: attr(data-label);
  position: absolute;
  inset: 0;                   /* ‚úÖ perfect centering */
  display: flex;
  align-items: center;
  justify-content: center;

  font-size: 28px;
  font-weight: 900;
  pointer-events: none;

  text-shadow:
    0 0 6px rgba(0,0,0,.45),
    0 0 14px rgba(0,0,0,.35);
}

#hitLine{
  position:absolute;left:0;right:0;bottom:80px;
  height:3px;background:#22d3ee;box-shadow:0 0 18px #22d3ee;
  z-index:1
}


/* JUDGEMENT */
.judge{
z-index: 5; 
  position:absolute;left:50%;bottom:120px;
  transform:translateX(-50%);
  font-size:36px;font-weight:900;
  animation:judge .6s forwards;
  pointer-events:none
}
.judge.sublime{
  color:#ff5fd2;
  text-shadow:0 0 12px #ff5fd2,0 0 32px #ff5fd2
}
.judge.great{color:#22d3ee}
.judge.ok{color:#facc15}
.judge.miss{color:#f87171}
@keyframes judge{
  to{opacity:0;transform:translateX(-50%) scale(1.3)}
}

/* SPARKS */
.spark{
  position:fixed;border-radius:50%;
  pointer-events:none;z-index:9999;
  animation:spark .35s ease-out forwards
}
@keyframes spark{
  from{opacity:1;transform:scale(.4)}
  to{opacity:0;transform:scale(1.4)}
}

/* MULTIPLIER FLASH */
#flash{
  position: absolute;
  inset: 0;
  pointer-events: none;
  opacity: 0;
  z-index: 9;
}

#flash.x2{
  background: rgba(250,204,21,0.6);
}

#flash.x3{
  background: rgba(220,38,38,0.6);
}

#flash.active{
  animation: flash .18s ease-out;
}

@keyframes flash{
  from{opacity:1}
  to{opacity:0}
}

/* GAME OVER */
#gameOver{
  position:absolute;inset:0;background:rgba(0,0,0,.75);
  display:none;align-items:center;justify-content:center
}
#gameOver .box{
  background:#020617;padding:22px 26px;border-radius:14px;text-align:center
}

#bottomRow .ad-slot {
  height: 100%;
}

/* LEADERBOARD */
#leaderboard{
  background:#020617;border-radius:14px;padding:12px
}
#leaderboard h3{text-align:center;margin:4px 0 10px}
.lb-row{
  display:flex;justify-content:space-between;
  padding:4px 0;font-size:14px;
  border-bottom:1px solid rgba(255,255,255,.08)
}
.lb-empty{text-align:center;opacity:.6;font-size:14px}

#lbLogo img{
  max-width: 100%;
  width: 260px;        /* keeps it tidy */
  height: auto;
  filter: drop-shadow(0 0 14px rgba(236,72,153,0.45));
}
@media (max-width: 900px) {

  #layout{
    grid-template-columns: 1fr; /* stack */
  }

  #leaderboard{
    margin-top: 14px;
  }

}
@media (max-width: 900px) {

  #bottomRow{
    grid-template-columns: 1fr;
    grid-template-rows: auto;
  }

  #lbLogoWrap{
    grid-column: auto;
    grid-row: auto;
    height: 220px;
  }

}
@media (max-width: 600px) {

  #game{
    height: 340px;
  }

  .key{
    font-size: 20px;
  }

  .judge{
    font-size: 28px;
  }

}
@media (max-width: 600px) {

  #titleLogo{
    max-width: 180px;
  }

  .ad-slot{
    height: 140px;
  }

}
/* ===== ROTATE DEVICE HINT (MOBILE ONLY) ===== */
#rotateHint {
  height: 100dvh;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 99999;

  display: none;
  align-items: center;
  justify-content: center;

  pointer-events: none; /* ‚úÖ CRITICAL */
}
/* ===== TABLET OPTIMISATION ===== */
@media (min-width: 768px) and (max-width: 1100px){

  #layout{
    grid-template-columns: 1fr 280px;
  }

  #game{
    height: 380px;
  }

  #titleLogo{
    max-width: 220px;
  }

}
</style>
</head>

<body>

<div id="page">
<main>
<div id="titleRow">
  <div class="ad-slot ad-image">
  <a href="https://galactic123.net" target="_blank">
    <img src="img/galactic123.png" alt="Galactic123">
  </a>
</div>

  <img
    src="img/rhythm-master-tr.png"
    alt="Rhythm Master"
    id="titleLogo"
  />

  <div class="ad-slot ad-image">
  <a href="https://metabattler.io" target="_blank">
    <img src="img/metabattler.png" alt="MetaBattler">
  </a>
</div>
</div>

<div id="top">
  <button id="loginBtn">Connect WAX</button>
  <button id="anchorLoginBtn" class="secondary">Anchor</button>
  <span id="userLabel"></span>
  <select id="trackSelect" disabled></select>
  <button id="startBtn" disabled>Start</button>
</div>

<div id="payment">
  <button id="payBtn" class="secondary">Pay 100 SSN</button>
  <span id="payStatus"></span>
  <a id="txLink" target="_blank" style="display:none">View Tx</a>
  <button id="seasonResetBtn" class="warn" style="display:none">New Season (Admin)</button>
</div>

<div id="hud">
  <div>Score: <span id="scoreEl">0</span></div>
  <div>Combo: <span id="comboEl">0</span></div>
  <div id="multiplier">x1</div>
</div>

<div id="layout">
  <div id="game" tabindex="0">
    <video id="bgVideo" playsinline muted preload="auto"></video>
    <div id="bg"></div>
    <div id="flash"></div>
    <div id="lanes"></div>
    <div id="hitLine"></div>

  <!-- ‚úÖ MOVE OVERLAY HERE -->
  <div id="comboOverlay"></div>

    <div id="gameOver">
      <div class="box">
        <h2>Game Over</h2>
        <div>Final Score: <b id="finalScore">0</b></div>
        <br>
        <button onclick="closeGameOver()">OK</button>
        <br><br>
        <button onclick="restartGame()" class="secondary">Restart</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ LEADERBOARD COLUMN -->
  <div id="leaderboard">
    <h3>Leaderboard</h3>
    <div id="lbList"></div>
  </div>
</div>

<!-- üëá THIS MUST BE OUTSIDE #layout -->
<div id="bottomRow">
  <div class="ad-slot ad-image">
  <a href="https://www.wax.io" target="_blank" rel="noopener noreferrer">
    <img
      src="img/waxlogo.png"
      alt="WAX Blockchain"
    >
  </a>
</div>
  <div class="ad-slot ad-image">
  <a href="https://neftyblocks.com/collection/sublimesound" target="_blank">
    <img src="img/seasonpass.png" alt="Buy Sublime Sounds NFTs">
  </a>
</div>
<div class="ad-slot ad-image">
  <a href="https://neftyblocks.com/collection/sublimesound" target="_blank">
    <img src="img/nfts.png" alt="Buy Sublime Sounds NFTs">
  </a>
</div>

  <div class="ad-slot ad-image">
  <a href="https://muenstervision.co/" target="_blank">
    <img src="img/Muenstervision.png" alt="Muenstervision">
  </a>
</div>
   <div class="ad-slot ad-image">
  <a href="https://waxcleanup.github.io/" target="_blank">
    <img src="img/cleanupcentr.png" alt="CleanUpCentr">CleanUp Centr
  </a>
</div>
     <div class="ad-slot ad-image">
  <a href="https://waxdao.io/" target="_blank">
    <img src="img/waxdao.png" alt="WaxDAO">CleanUp Centr
  </a>
</div>

<div id="lbLogoWrap"></div>
</div>
</main>
<div id="rotateHint">
  <div class="rotate-box">
    <div class="icon">üì±‚Üª</div>
    <div class="text">
      Rotate your device<br>
      for the best experience
    </div>
  </div>
</div>
<script>
/* ===== GLOBAL STATE (MUST BE FIRST) ===== */
let pausedForOrientation = false;
let playing = false;
let ended = false;
let started = false;

let user = null;
let paidForThisTrack = false;
// üîë Wallet state
let walletType = "wax"; // "wax" | "anchor"
let anchorSession = null;

let activeMultiplier = 1;
let multiplierTimeout = null;

let tracks = [];
let currentTrack = null;
let audio = null;
let notes = [];
let raf = null;

let score = 0;
let combo = 0;
let lastComboMilestone = 0;
// ===== KEYBOARD INPUT =====
const KEY_TO_LANE = {
  a: 0,
  s: 1,
  d: 2,
  f: 3,
  g: 4
};

window.addEventListener("keydown", (e) => {
  if (!playing || ended) return;

  const key = e.key.toLowerCase();
  if (key in KEY_TO_LANE) {
    e.preventDefault();
    hitLane(KEY_TO_LANE[key]);
  }
});
function pauseForOrientation(){
  if (!playing || pausedForOrientation) return;

  pausedForOrientation = true;

  // Pause audio/video
  if (audio && !audio.paused) audio.pause();
  if (!bgVideo.paused) bgVideo.pause();

  // Stop game loop
  cancelAnimationFrame(raf);
}

function resumeFromOrientation(){
  if (!playing || !pausedForOrientation) return;

  pausedForOrientation = false;

  // Resume audio/video
  if (audio) audio.play().catch(()=>{});
  if (bgVideo.src) bgVideo.play().catch(()=>{});

  // Resume loop
  loop();
}
let gameStartTime = 0;
const lanes = document.getElementById("lanes");
const game = document.getElementById("game");
const bg = document.getElementById("bg");
const bgVideo = document.getElementById("bgVideo");
const flash = document.getElementById("flash");
const txLink = document.getElementById("txLink");
const SUPABASE_URL = "https://eorhtzsejlgteagloeyn.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvcmh0enNlamxndGVhZ2xvZXluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MDcwNDQsImV4cCI6MjA4MTQ4MzA0NH0.-Vq-P1gwlt7A87yFI7EQRPvykVUpZT9vupj4CHigIeA";

// IMPORTANT: rename variable to avoid collision
const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

const loginBtn = document.getElementById("loginBtn");
const startBtn = document.getElementById("startBtn");
const trackSelect = document.getElementById("trackSelect");
const userLabel = document.getElementById("userLabel");
const scoreEl = document.getElementById("scoreEl");
const comboEl = document.getElementById("comboEl");
const multiplier = document.getElementById("multiplier");
const lbList = document.getElementById("lbList");
const finalScore = document.getElementById("finalScore");
const seasonResetBtn = document.getElementById("seasonResetBtn");
const payStatus = document.getElementById("payStatus");
const payBtn = document.getElementById("payBtn");
const anchorLoginBtn = document.getElementById("anchorLoginBtn");

const rotateHint = document.getElementById("rotateHint");

function forceUnmuteMedia() {
  if (audio) {
    audio.muted = false;
    audio.volume = 1;
  }

  if (bgVideo) {
    bgVideo.muted = false;
    bgVideo.volume = 1;
  }
}

function checkOrientation(){
  if (!rotateHint) return;

  const isMobile = window.innerWidth <= 768;
  const isPortrait = window.matchMedia("(orientation: portrait)").matches;

  const shouldShow = isMobile && isPortrait;

  rotateHint.style.display = shouldShow ? "flex" : "none";

  if (playing) {
    if (shouldShow) {
      pauseForOrientation();
    } else {
      resumeFromOrientation();
    }
  }

  document.documentElement.style.setProperty(
    "--vh",
    window.innerHeight * 0.01 + "px"
  );
}checkOrientation();

window.addEventListener("orientationchange", () => {
  setTimeout(checkOrientation, 300);
});

window.addEventListener("resize", () => {
  setTimeout(checkOrientation, 300);
});

/* ===== GAME PASS CONFIG ===== */
const SEASON_PASS_TEMPLATE_ID = "123456"; // üëà replace later
const ENABLE_SEASON_PASS = false; // üîí toggle season pass on/off

/* ===== IPFS FALLBACK SETUP ===== */
const IPFS_GATEWAYS = [
"https://sublimesounds.mypinata.cloud/ipfs/",
"https://1mvpnftco1.mypinata.cloud/ipfs/",
  "https://gateway.pinata.cloud/ipfs/",
  "https://cloudflare-ipfs.com/ipfs/",
  "https://ipfs.io/ipfs/"
];

function resolveIPFS(cid, index = 0) {
  if (!cid) return "";
  return IPFS_GATEWAYS[index] + cid;
}

function normalizeIPFS(value) {
  if (!value) return null;

  if (Array.isArray(value)) value = value[0];

  if (typeof value === "object" && value.ipfs) {
    return value.ipfs;
  }

  if (typeof value === "string") {
    if (value.startsWith("ipfs://")) {
      return value.replace("ipfs://", "");
    }

    const idx = value.indexOf("/ipfs/");
    if (idx !== -1) {
      return value.substring(idx + 6);
    }

    return value; // already CID
  }

  return null;
}

function loadAudioWithFallback(cid, onReady) {
  let index = 0;
  const audio = new Audio();

  function tryLoad() {
    audio.src = resolveIPFS(cid, index);
    audio.onloadedmetadata = () => onReady(audio);
    audio.onerror = () => {
      index++;
      if (index < IPFS_GATEWAYS.length) {
        tryLoad();
      } else {
        console.error("Audio failed on all gateways:", cid);
      }
    };
  }

  tryLoad();
}

function loadVideoWithFallback(cid, videoEl, onReady) {
  let index = 0;

  function tryLoad() {
    const url = resolveIPFS(cid, index);
    videoEl.src = url;
    videoEl.load();

    videoEl.onloadedmetadata = () => onReady();
    videoEl.onerror = () => {
      index++;
      if (index < IPFS_GATEWAYS.length) {
        tryLoad();
      } else {
        console.error("Video failed on all gateways:", cid);
      }
    };
  }

  tryLoad();
}

/* ===== CONFIG ===== */
const START_DELAY = 5;
const COLLECTION="sublimesound";
const SEASON_ID="season1";
const ADMINS = ["fs1r2.wam"];
const SSN_CONTRACT="metatoken.gm";
const SSN_SYMBOL="SSN";
const SSN_AMOUNT="100.00000000";
const SSN_RECEIVER="a1hd.wam";
const LANES=5;
const NOTE_SPEED=260;
const HIT_WINDOW=0.18;


/* ===== WAX ===== */
const wax=new waxjs.WaxJS({rpcEndpoint:"https://api.waxsweden.org"});

// ===== ANCHOR SETUP =====
const anchorLink = new AnchorLink({
  transport: new AnchorLinkBrowserTransport(),
  chains: [{
    chainId: "1064487b3cd1a897ce03ae5b6a865651747e2e152090f99c1d19d44e01aea5a4",
    nodeUrl: "https://api.waxsweden.org"
  }]
});

/* ===== SSN PAYMENT HANDLER ===== */
payBtn.onclick = async () => {
  if (!user) {
    alert("Please connect WAX first");
    return;
  }

  if (paidForThisTrack) return;

  try {
    payStatus.textContent = "Processing payment...";
    payStatus.style.color = "#facc15";
    payBtn.disabled = true;

let result;

if (walletType === "anchor") {
  if (!anchorSession) {
    throw new Error("Anchor session missing");
  }

  const actor = anchorSession.auth.actor.toString();

  result = await anchorSession.transact(
    {
      actions: [{
        account: SSN_CONTRACT,
        name: "transfer",
        authorization: [{
          actor,
          permission: "active"
        }],
        data: {
          from: actor,
          to: SSN_RECEIVER,
          quantity: `${SSN_AMOUNT} ${SSN_SYMBOL}`,
          memo: `Rhythm Master ‚Äì ${currentTrack?.name || "Track"}`
        }
      }]
    },
    {
      blocksBehind: 3,
      expireSeconds: 120
    }
  );

} else {
  result = await wax.api.transact(
    {
      actions: [{
        account: SSN_CONTRACT,
        name: "transfer",
        authorization: [{
          actor: user,
          permission: "active"
        }],
        data: {
          from: user,
          to: SSN_RECEIVER,
          quantity: `${SSN_AMOUNT} ${SSN_SYMBOL}`,
          memo: `Rhythm Master ‚Äì ${currentTrack?.name || "Track"}`
        }
      }]
    },
    {
      blocksBehind: 3,
      expireSeconds: 120
    }
  );
}
    paidForThisTrack = true;
    startBtn.disabled = false;
    payBtn.disabled = true;

    payStatus.textContent = "Payment successful ‚úî";
    payStatus.style.color = "#22d3ee";

const txid =
  result?.transaction_id ||
  result?.processed?.id;

if (txLink && txid) {
  txLink.href = `https://waxblock.io/transaction/${txid}`;
  txLink.style.display = "inline";
}

  } catch (err) {
    // üî• IMPORTANT FIX
    console.warn("WaxJS error (may still be successful):", err);

    // If WaxJS threw but tx already went through ‚Üí allow play
    paidForThisTrack = true;
    startBtn.disabled = false;
    payBtn.disabled = true;

    payStatus.textContent = "Payment confirmed ‚úî";
    payStatus.style.color = "#22d3ee";
  }
};

/* ===== BUILD LANES ===== */
for(let i=0;i<LANES;i++){
  const l=document.createElement("div");
  l.className="lane";
l.addEventListener("pointerdown", e => {
  if (playing) {
    e.preventDefault();   // ‚úÖ only block during gameplay
    hitLane(i);
  }
});
  const k=document.createElement("div");
  k.className="key";
  k.textContent=["A","S","D","F","G"][i];
  l.appendChild(k);
  lanes.appendChild(l);
}

anchorLoginBtn.onclick = async () => {
  try {
    walletType = "anchor";
    anchorSession = null;

    loginBtn.disabled = true;
    anchorLoginBtn.disabled = true;

    const identity = await anchorLink.login("Rhythm Master");

    anchorSession = identity.session;
    user = anchorSession.auth.actor.toString();

    userLabel.textContent = user;

    paidForThisTrack = false;
    startBtn.disabled = true;

    payBtn.disabled = false;
    payBtn.style.display = "inline-block";
    payStatus.textContent = "Pay 100 SSN to play";
    payStatus.style.color = "#facc15";

    await loadNFTs();

  } catch (err) {
    console.error("Anchor login failed", err);

    walletType = "wax";
    anchorSession = null;

    loginBtn.disabled = false;
    anchorLoginBtn.disabled = false;

    alert("Anchor login failed");
  }
};
/* ===== LOGIN ===== */
loginBtn.onclick = async () => {
  try {
    await wax.login();
user = wax.userAccount;   // ‚úÖ ALWAYS correct
userLabel.textContent = user;

paidForThisTrack = false;
payBtn.disabled = false;
payBtn.style.display = "inline-block";

startBtn.disabled = true; // must pay first

    /* üîë ADMIN BYPASS ‚Äî ALWAYS FIRST */
if (ADMINS.includes(user)) {
  paidForThisTrack = true;

  payBtn.disabled = true;
  payBtn.style.display = "none"; // üëà fully hidden
  payStatus.textContent = "Admin access";
  payStatus.style.color = "#22d3ee";

  startBtn.disabled = false;
  seasonResetBtn.style.display = "inline-block";

  await loadNFTs();
  return;
}

/* üîê SEASON PASS CHECK (NON-ADMIN) */
let hasPass = true;

if (ENABLE_SEASON_PASS) {
  hasPass = await checkSeasonPass(user);
}

if (hasPass) {
  startBtn.disabled = false;
} else {
  startBtn.disabled = true;
  payStatus.textContent = "Season Pass NFT required to play";
  payStatus.style.color = "#facc15";
}

await loadNFTs();
  } catch (err) {
    console.error("WAX login failed", err);
    alert("WAX login failed");
  }
};

/* ===== NFT LOAD ===== */
async function loadNFTs() {
  console.log("Loading NFTs for:", user);

  trackSelect.innerHTML = "";
  tracks = [];

  const r = await fetch(
    `https://aa.wax.blacklusion.io/atomicassets/v1/assets` +
    `?owner=${encodeURIComponent(user)}` +
    `&collection_name=${COLLECTION}` +
    `&limit=1000`
  );

  const assets = (await r.json()).data || [];

  const seenTemplates = new Set();

for (const a of assets) {
  const templateId = a.template?.template_id;
  if (!templateId) continue;

const t = a.template?.immutable_data || {};
const m = a.data || {};

const audioCID = normalizeIPFS(m.audio || t.audio);
const videoCID = normalizeIPFS(
  m.video ||
  t.video ||
  m.animation_url ||
  t.animation_url ||
  m.video_url ||
  t.video_url ||
  m.media ||
  t.media
);
const imageCID = normalizeIPFS(
  m.img ||
  t.img ||
  m.image ||
  t.image
);

if (seenTemplates.has(templateId)) {
  const existing = tracks.find(t => t.template_id === templateId);

  // üî• upgrade image if missing
  if (existing && !existing.imageCID && imageCID) {
    existing.imageCID = imageCID;
  }

  continue;
}

seenTemplates.add(templateId);
  // ‚ùó allow VIDEO-ONLY or AUDIO-ONLY
  if (!audioCID && !videoCID) continue;

  tracks.push({
    asset_id: a.asset_id,          // first asset wins
    template_id: templateId,
    name: m.name || t.name || `Template #${templateId}`,
    audioCID,
    videoCID,
    imageCID
  });

  }
  if (!tracks.length) {
    trackSelect.disabled = true;
    startBtn.disabled = true;
    return;
  }

  // ‚úÖ Populate dropdown ONCE
  tracks.forEach((t, i) => {
    const o = document.createElement("option");
    o.value = i;
    o.textContent = t.name;
    trackSelect.appendChild(o);
  });

  currentTrack = tracks[0];
  applyTrackVisuals();

  trackSelect.disabled = false;
  startBtn.disabled = false;

  loadLeaderboard();
}

trackSelect.onchange=e=>{
if (!ADMINS.includes(user)) {
  paidForThisTrack = false;
  startBtn.disabled = true;
  payBtn.disabled = false;

  payStatus.textContent = "Pay 100 SSN for this track";
  payStatus.style.color = "#facc15";
}
  currentTrack=tracks[e.target.value];
  applyTrackVisuals();
  loadLeaderboard();
};

function applyTrackVisuals() {
  // reset
  bg.style.backgroundImage = "";
  bgVideo.pause();
  bgVideo.style.display = "none";
  bgVideo.src = "";

  // ‚úÖ ALWAYS set image if available (fallback)
  if (currentTrack.imageCID) {
    bg.style.backgroundImage =
      `url(${resolveIPFS(currentTrack.imageCID)})`;
  }

  // ‚ñ∂ Then try video ON TOP
  if (currentTrack.videoCID) {
    bgVideo.style.display = "block";
    loadVideoWithFallback(currentTrack.videoCID, bgVideo, () => {
      // video ready
    });
  }
}

/* ===== GAME START ===== */
startBtn.onclick = () => {
anchorLoginBtn.disabled = true;
  if (playing) return;

  if (!paidForThisTrack) {
    alert("Please pay 100 SSN to play this track");
    return;
  }

  playing = true;
  ended = false;

 game.focus();

loginBtn.disabled = true;
loginBtn.style.opacity = "0.4";
loginBtn.style.cursor = "not-allowed";

forceUnmuteMedia(); // üîä CRITICAL: allow sound

gameStartTime = performance.now() / 1000;

  startBtn.disabled = true;
  trackSelect.disabled = true;

  score=0; combo=0;
  scoreEl.textContent=0;
  comboEl.textContent=0;

  notes=[];

if (currentTrack.videoCID) {
  bgVideo.currentTime = 0;
}

if (currentTrack.audioCID) {
  loadAudioWithFallback(currentTrack.audioCID, (loadedAudio) => {
    audio = loadedAudio;
    spawnNotes();
    audio.play().catch(()=>{});
    loop();
  });
}

// üé• VIDEO-ONLY TRACK START (FIXED)
if (!currentTrack.audioCID && currentTrack.videoCID) {
  bgVideo.currentTime = 0;

function startVideoGame() {
  if (started) return;
  started = true;

  forceUnmuteMedia(); // üîä ensure sound

  spawnNotes();
  bgVideo.play().catch(() => {});
  loop();
}

  bgVideo.play().then(() => {
    spawnNotes();
    loop();
  }).catch(err => {
    console.warn("Video play blocked, retrying...", err);

    // Retry after small delay (IPFS gateways can lag)
    setTimeout(() => {
      bgVideo.play().then(() => {
        spawnNotes();
        loop();
      });
    }, 500);
  });
}
};

bgVideo.onended=()=>{ if(playing) endGame(); };

/* ===== GAME LOOP ===== */
function spawnNotes(){
  notes = [];

  const duration =
    audio?.duration ??
    bgVideo?.duration ??
    60;

  for(let t = 1; t < duration; t += 0.6){
    const lane = Math.floor(Math.random() * LANES);
    const el = document.createElement("div");
const roll = Math.random();
let type = "normal";

if (roll < 0.03) type = "x3";
else if (roll < 0.08) type = "x2";

el.className = "note";

if (type === "x2") {
  el.classList.add("mult-x2");
  el.dataset.label = "x2";
}
else if (type === "x3") {
  el.classList.add("mult-x3");
  el.dataset.label = "x3";
}
    lanes.children[lane].appendChild(el);

   notes.push({ time: t + START_DELAY, lane, el, hit:false, type });
  }
}

function loop(){
   if (!playing || pausedForOrientation) return;
let now;

if (audio && !audio.paused) {
  now = audio.currentTime;
} else if (bgVideo && !bgVideo.paused && bgVideo.currentTime > 0) {
  now = bgVideo.currentTime;
} else {
  now = performance.now() / 1000 - gameStartTime;
}
  if(audio && now>=audio.duration-0.05){ endGame(); return; }

  notes.forEach(n=>{
    if(!n.hit){
      n.el.style.top=(360-(n.time-now)*NOTE_SPEED)+"px";
    }
  });
  raf=requestAnimationFrame(loop);
}
function pulseLane(i, perfect=false){
  const lane = lanes.children[i];
  lane.classList.remove("hit","perfect");
  void lane.offsetWidth;
  lane.classList.add(perfect ? "perfect" : "hit");
  setTimeout(()=>lane.classList.remove("hit","perfect"),120);
}

function shakeGame(){
  game.classList.remove("shake");
  void game.offsetWidth;
  game.classList.add("shake");
}

function spawnSpark(i, acc){
  const r = lanes.children[i].getBoundingClientRect();
  const y = hitLine.getBoundingClientRect().top;
  const size = acc > 0.85 ? 420 : 200;

  const s = document.createElement("div");
  s.className = "spark";
  s.style.width = s.style.height = size + "px";
  s.style.left = (r.left + r.width/2 - size/2) + "px";
  s.style.top = (y - size/2) + "px";
  s.style.background =
    acc > 0.85
      ? "radial-gradient(circle,#fff,#ff5fd2,transparent 70%)"
      : "radial-gradient(circle,#fff,#22d3ee,transparent 70%)";

  document.body.appendChild(s);
  setTimeout(()=>s.remove(),400);
}

/* ===== HIT ===== */
function hitLane(i){
game.focus();
  if(!playing || ended) return;

  const now =
    audio?.currentTime ??
    bgVideo?.currentTime ??
    performance.now() / 1000;

  let best = null, bd = 999;

  for(const n of notes){
    if(n.hit || n.lane !== i) continue;
    const d = Math.abs(n.time - now);
    if(d < bd){ bd = d; best = n; }
  }

  if(best && bd <= HIT_WINDOW){

    // multiplier pickup
    if(best.type === "x2") activateMultiplier(2, 5);
    else if(best.type === "x3") activateMultiplier(3, 3);

    best.hit = true;
best.el.remove();

const acc = 1 - bd / HIT_WINDOW;

let judgement = "ok";

if (acc >= 0.85) judgement = "sublime";
else if (acc >= 0.65) judgement = "great";
else judgement = "ok";

/* ===== COMBO LOGIC ===== */
// ‚úÖ GREAT + SUBLIME build combo
if (judgement === "sublime" || judgement === "great") {
  combo++;

  if (combo >= 50 && lastComboMilestone < 50) {
    showComboCelebration("RHYTHM MASTER!", "combo-50");
    lastComboMilestone = 50;
  } else if (combo >= 30 && lastComboMilestone < 30) {
    showComboCelebration("SUBLIME COMBO!", "combo-30");
    lastComboMilestone = 30;
  } else if (combo >= 20 && lastComboMilestone < 20) {
    showComboCelebration("AMAZING COMBO!", "combo-20");
    lastComboMilestone = 20;
  } else if (combo >= 10 && lastComboMilestone < 10) {
    showComboCelebration("GREAT COMBO!", "combo-10");
    lastComboMilestone = 10;
  } else if (combo >= 5 && lastComboMilestone < 5) {
    showComboCelebration("NICE COMBO!", "combo-5");
    lastComboMilestone = 5;
  }
} else {
  combo = 0;
  lastComboMilestone = 0;
}
score += Math.floor(
  judgement === "sublime"
    ? 1000 * acc * activeMultiplier
    : judgement === "great"
    ? 700 * acc * activeMultiplier
    : 400 * acc
);

// Visual feedback
pulseLane(i, judgement === "sublime");
spawnSpark(i, acc);
if (judgement === "sublime") shakeGame();

showJudge(judgement);

  } else {
    combo = 0;
lastComboMilestone = 0;
    pulseLane(i, false);
    showJudge(false, true);
  }

  scoreEl.textContent = score;
  comboEl.textContent = combo;
}
function activateMultiplier(value, seconds){
  activeMultiplier = value;
  multiplier.textContent = "x" + value;

  // üî• force-restart flash animation
  flash.className = "";
  void flash.offsetWidth; // üëà THIS LINE FORCES REFLOW
  flash.classList.add("active", value === 2 ? "x2" : "x3");

  if(multiplierTimeout) clearTimeout(multiplierTimeout);

  multiplierTimeout = setTimeout(()=>{
    activeMultiplier = 1;
    multiplier.textContent = "x1";
  }, seconds * 1000);
}

/* ===== JUDGE ===== */
function showJudge(type, miss = false) {
  const j = document.createElement("div");
  j.className = "judge";

  if (miss) {
    j.textContent = "MISS";
    j.classList.add("miss");
  }
  else if (type === "sublime") {
    j.textContent = "SUBLIME!";
    j.classList.add("sublime");
  }
  else if (type === "great") {
    j.textContent = "GREAT!";
    j.classList.add("great");
  }
  else {
    j.textContent = "OK";
    j.classList.add("ok");
  }

  game.appendChild(j);
  setTimeout(() => j.remove(), 600);
}

function showComboCelebration(text, className) {
  const el = document.createElement("div");
  el.className = `combo-celebrate ${className}`;
  el.textContent = text;

  document.getElementById("comboOverlay").appendChild(el);

  setTimeout(() => el.remove(), 2000);
}

/* ===== END ===== */
function clearNotes(){
  notes.forEach(n => {
    if (n.el && n.el.parentNode) {
      n.el.remove();
    }
  });
  notes = [];
}
async function endGame(){
anchorLoginBtn.disabled = false;
paidForThisTrack = ADMINS.includes(user); // admins stay free

if (!ADMINS.includes(user)) {
  payBtn.disabled = false;
  payStatus.textContent = "Pay 100 SSN to play again";
  payStatus.style.color = "#facc15";
}
pausedForOrientation = false;
rotateHint.style.display = "none";
activeMultiplier = 1;
if(multiplierTimeout) clearTimeout(multiplierTimeout);
  if(ended) return;
  ended = true;
  playing = false;

  clearNotes(); // ‚¨ÖÔ∏è ADD THIS LINE

  cancelAnimationFrame(raf);
  if(audio) audio.pause();
  bgVideo.pause();

  finalScore.textContent = score;
  gameOver.style.display = "flex";
 await submitScore();
loadLeaderboard();

  startBtn.disabled = false;
  trackSelect.disabled = false;

loginBtn.disabled = false;
loginBtn.style.opacity = "1";
loginBtn.style.cursor = "pointer";
}
function closeGameOver(){
  gameOver.style.display="none";
  lanes.style.pointerEvents = "auto"; // ‚¨ÖÔ∏è ADD THIS

  // üîí REQUIRE PAYMENT FOR NEXT GAME (NON-ADMINS)
  if (!ADMINS.includes(user)) {
    paidForThisTrack = false;
if (!ADMINS.includes(user)) {
  startBtn.disabled = true;
  payStatus.textContent = "Pay 100 SSN to play again";
  payStatus.style.color = "#facc15";
}
  }
}

/* ===== LEADERBOARD ===== */
function lbKey(){return `leaderboard_${SEASON_ID}_${currentTrack.name}`}
async function loadLeaderboard() {
  lbList.innerHTML = "";

const { data, error } = await supabaseClient
  .from("leaderboard")
  .select("*")
  .eq("season", SEASON_ID)
  .eq("track", currentTrack.name)
  .order("score", { ascending: false })
  .limit(10);

  if (error || !data || !data.length) {
    lbList.innerHTML = '<div class="lb-empty">No scores yet</div>';
    return;
  }

  data.forEach((r, i) => {
    const d = document.createElement("div");
    d.className = "lb-row";
    d.innerHTML = `
      <span>${i + 1}. ${r.user_account}</span>
      <span>${r.score}</span>
    `;
    lbList.appendChild(d);
  });
}

async function submitScore() {
  if (!user) return;

  const { data: existing } = await supabaseClient
    .from("leaderboard")
    .select("score")
    .eq("season", SEASON_ID)
    .eq("track", currentTrack.name)
    .eq("user_account", user)
    .single();

  if (existing && existing.score >= score) {
    return; // keep higher score
  }

  const { error } = await supabaseClient
    .from("leaderboard")
    .upsert(
      {
        season: SEASON_ID,
        track: currentTrack.name,
        user_account: user,
        score,
        max_combo: combo,
        has_autograph: false
      },
      { onConflict: "season,track,user_account" }
    );

  if (error) {
    console.error("Leaderboard submit failed:", error);
  }
}

function restartGame(){
loginBtn.disabled = false;
loginBtn.style.opacity = "1";
loginBtn.style.cursor = "pointer";
  closeGameOver();
  clearNotes();

  ended = false;
  playing = false;
  activeMultiplier = 1;
  multiplier.textContent = "x1";

  if(multiplierTimeout) clearTimeout(multiplierTimeout);

  if(audio){
    audio.pause();
    audio.currentTime = 0;
  }

  bgVideo.pause();
  bgVideo.currentTime = 0;

  startBtn.disabled = false;
  trackSelect.disabled = false;

  startBtn.click();
}
async function checkSeasonPass(owner) {
  try {
    const url = `https://aa.wax.blacklusion.io/atomicassets/v1/assets?owner=${owner}&template_id=${SEASON_PASS_TEMPLATE_ID}&limit=1`;
    const res = await fetch(url);
    const json = await res.json();

    return json.data && json.data.length > 0;
  } catch (err) {
    console.error("Season pass check failed", err);
    return false;
  }
}
</script>
</div>
</div>
</body>
</html>